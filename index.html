<!DOCTYPE html>
<html lang="en">
<head>
    <!-- Montserrat font for charity: water brand -->
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="icon" href="assets/favicon.svg" type="image/svg+xml">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="description" content="Last Drop - A Charity: Water Run. Every drop counts. Every mile matters. Run for the last clean water.">
    <title>Last Drop - A Charity: Water Run</title>
    <style>
@import url('https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700;800;900&family=Work+Sans:wght@300;400;500;600;700&display=swap');
/* Mission Objectives Controls & Pro Tip */
.mission-controls {
    margin-top: 1rem;
}
.mission-protip {
    margin-top: 1rem;
    color: var(--orange-bright);
}
/* Pro Tips Card Refactor */
.card-pro-tips {
    /* Inherits card-orange-light styles */
}
.card-grid-cyan.card-pro-tips-grid {
    display: grid;
    gap: 0.5rem;
    color: var(--cyan-bright);
}
.card-pro-tips-goal {
    margin-top: 0.75rem;
    color: var(--orange-bright);
}
/* Difficulty Modes Card Refactor */
.card-difficulty-modes {
    /* Inherits card-cyan styles */
}
.card-grid-cyan.card-difficulty-grid {
    display: grid;
    gap: 0.75rem;
    color: var(--cyan-bright);
}
.card-strong-green {
    color: #22c55e;
}
.card-strong-red {
    color: #ef4444;
}
/* Scoring System Card Refactor */
.card-orange-light {
    background: rgba(255, 111, 0, 0.1);
    border: 2px solid rgba(255, 111, 0, 0.3);
    border-radius: 0.75rem;
    padding: 1.5rem;
    margin-bottom: 1.5rem;
}
.card-title-orange {
    color: var(--orange-bright);
    margin-bottom: 1rem;
    display: flex;
    align-items: center;
    gap: 0.5rem;
}
.card-grid-cyan.card-scoring-grid {
    display: grid;
    gap: 0.5rem;
    color: var(--cyan-bright);
}
.card-combo-box.card-combo-box-orange {
    margin-top: 0.75rem;
    padding: 0.75rem;
    background: rgba(0, 0, 0, 0.3);
    border-radius: 0.5rem;
}
.card-strong-orange {
    color: var(--orange-bright);
}
/* Power-Ups Card Refactor */
.card-cyan {
    background: rgba(0, 151, 167, 0.2);
    border: 2px solid var(--cyan-dark);
    border-radius: 0.75rem;
    padding: 1.5rem;
    margin-bottom: 1.5rem;
}
.card-title-cyan {
    color: var(--cyan-glow);
    margin-bottom: 1rem;
    display: flex;
    align-items: center;
    gap: 0.5rem;
}
.card-grid-cyan.card-powerups-grid {
    display: grid;
    gap: 0.75rem;
    color: var(--cyan-bright);
}
.card-powerup-flex {
    display: flex;
    align-items: start;
    gap: 0.75rem;
}
.card-powerup-icon {
    font-size: 1.5rem;
}
.card-strong-cyan {
    color: var(--cyan-glow);
}
.card-small-cyan {
    color: var(--cyan-medium);
    font-size: 0.95em;
}
        /* Click Mechanics Card Styles */
        .card-orange {
            background: rgba(255, 111, 0, 0.1);
            border: 2px solid rgba(255, 111, 0, 0.3);
            border-radius: 0.75rem;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
        }
        .card-title-orange {
            color: var(--orange-bright);
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        .card-grid-cyan {
            display: grid;
            gap: 0.75rem;
            color: var(--cyan-bright);
        }
        .card-strong-cyan {
            color: var(--cyan-glow);
        }
        .card-strong-orange {
            color: var(--orange-bright);
        }
        .card-combo-box {
            margin-top: 0.5rem;
            padding: 0.75rem;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 0.5rem;
        }
        /* Sidebar and Mission Data Card Styles */
        .mission-data-header {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        .mission-data-logo {
            height: 1.5em;
            vertical-align: middle;
        }
        .sidebar-difficulty {
            width: 100%;
            text-align: center;
            margin-bottom: 1rem;
        }
        .progress-container-scroll {
            max-height: 30vh;
            overflow-y: auto;
        }
        .btn-large {
            font-size: 1.125rem;
            padding: 1rem 2.5rem;
        }
        .btn-medium {
            width: auto;
            padding: 0.625rem 1.25rem;
        }
        .overlay-title-failed {
            color: var(--orange-bright);
        }
        .text-cyan-glow {
            color: var(--cyan-glow);
        }
        .text-cyan-bright {
            color: var(--cyan-bright);
        }
        .text-orange-bright {
            color: var(--orange-bright);
        }
        .mt-1 {
            margin-top: 1rem;
        }
        .mt-2 {
            margin-top: 2rem;
        }
        .mb-1 {
            margin-bottom: 1rem;
        }
        .mb-2 {
            margin-bottom: 2rem;
        }
        .flex-center {
            display: flex;
            gap: 1rem;
            justify-content: center;
            margin-top: 2rem;
        }
        .score-large {
            font-size: 3rem;
            font-weight: 900;
            color: var(--cyan-glow);
            text-shadow: 0 0 20px rgba(0, 217, 255, 0.6);
            margin-bottom: 0.5rem;
        }
        .main-layout {
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }
        .flex-1 {
            flex: 1;
        }
        .runner-img-container {
            text-align: center;
            margin: 32px 0;
        }
        .runner-img {
            max-width: 300px;
            width: 100%;
            height: auto;
        }
        .difficulty-selector-container {
            margin: 2rem 0;
        }
        .difficulty-title {
            color: var(--text-orange);
            margin-bottom: 1rem;
            font-size: 1.25rem;
        }
        .difficulty-name.recruit {
            color: var(--green-bright);
        }
        .difficulty-name.runner {
            color: var(--cyan-glow);
        }
        .difficulty-name.wasteland {
            color: var(--red-bright);
        }
        /* ========== Theme Colors (Teal & Orange Wasteland) ========== */
        :root {
            --cyan-glow: #00d9ff;
            --cyan-bright: #00b8d4;
            --cyan-medium: #0097a7;
            --cyan-dark: #006064;
            --orange-bright: #ff9800;
            --orange-medium: #f57c00;
            --orange-dark: #e65100;
            --green-bright: #22c55e;
            --red-bright: #ef4444;
            --wasteland-dark: #0a1f2e;
            --wasteland-medium: #163447;
            --wasteland-sand: #d4a574;
            --text-cyan: #00d9ff;
            --text-orange: #ff9800;
            --bg-gradient: linear-gradient(180deg, #0a1f2e 0%, #163447 50%, #1a4d5c 100%);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        /* charity: water inspired typography - clean, modern, humanitarian */
        @import url('https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700;800;900&family=Work+Sans:wght@300;400;500;600;700&display=swap');

        body {
            font-family: 'Montserrat', 'Arial', sans-serif;
            background: var(--bg-gradient);
            color: var(--text-cyan);
            overflow: hidden;
        h1, h2, h3, h4, h5, h6, .footer-text h3 {
            font-family: 'Montserrat', 'Segoe UI', Arial, sans-serif;
            font-weight: 700;
        }
            position: relative;
            /* Fix for mobile viewport height */
            min-height: 100vh;
            min-height: -webkit-fill-available;
        }

        html {
            height: -webkit-fill-available;
        }

        /* ========== Animated Background ========== */
        .bg-animated {
            position: fixed;
            inset: 0;
            background: var(--bg-gradient);
            z-index: -1;
            overflow: hidden;
        }

        .bg-animated::before {
            content: '';
            position: absolute;
            inset: 0;
            background-image: 
                linear-gradient(45deg, transparent 48%, rgba(0, 217, 255, 0.03) 49%, rgba(0, 217, 255, 0.03) 51%, transparent 52%),
                linear-gradient(-45deg, transparent 48%, rgba(255, 152, 0, 0.03) 49%, rgba(255, 152, 0, 0.03) 51%, transparent 52%);
            background-size: 40px 40px;
            animation: gridMove 20s linear infinite;
        }

        @keyframes gridMove {
            0% { transform: translate(0, 0); }
            100% { transform: translate(40px, 40px); }
        }

        /* ========== Container ========== */
        .game-wrapper {
            width: 100%;
            max-width: 100vw;
            display: flex;
            flex-direction: column;
            flex: 1 1 auto;
            overflow-y: auto;
            min-height: 0;
            padding: 0.75rem;
            padding-left: max(0.75rem, env(safe-area-inset-left));
            padding-right: max(0.75rem, env(safe-area-inset-right));
            padding-top: max(0.75rem, env(safe-area-inset-top));
            padding-bottom: max(0.75rem, env(safe-area-inset-bottom));
            gap: 0.75rem;
            box-sizing: border-box;
        }

        /* ========== Header ========== */
        .header {
            background: rgba(10, 31, 46, 0.9);
            padding: 1rem 1.5rem;
            border-radius: 0.75rem;
            border: 2px solid var(--cyan-dark);
            box-shadow: 
                0 0 20px rgba(0, 217, 255, 0.3),
                inset 0 0 20px rgba(0, 217, 255, 0.1);
            position: relative;
            overflow: hidden;
        }

        .header::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(0, 217, 255, 0.1), transparent);
            animation: scanline 3s infinite;
        }

        @keyframes scanline {
            0%, 100% { left: -100%; }
            50% { left: 100%; }
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: relative;
            z-index: 1;
        }

        .logo-section {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .water-drop-logo {
            width: 50px;
            height: 50px;
            position: relative;
            animation: float 3s ease-in-out infinite;
        }

        @keyframes float {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-8px); }
        }

        .water-drop-logo svg {
            width: 100%;
            height: 100%;
            filter: drop-shadow(0 0 10px var(--cyan-glow));
        }

        .title-block h1 {
            font-family: 'Montserrat', sans-serif;
            font-size: 2rem;
            font-weight: 800;
            color: var(--cyan-glow);
            text-shadow: 
                0 0 20px rgba(0, 217, 255, 0.8),
                0 0 40px rgba(0, 217, 255, 0.4);
            letter-spacing: 0.08em;
            margin-bottom: 0.25rem;
        }

        .subtitle {
            font-family: 'Montserrat', sans-serif;
            font-size: 0.875rem;
            color: var(--text-orange);
            font-weight: 700;
            letter-spacing: 0.08em;
            text-transform: uppercase;
        }

        .tagline {
            font-family: 'Work Sans', sans-serif;
            font-size: 0.75rem;
            color: var(--cyan-bright);
            font-weight: 400;
            font-style: italic;
            margin-top: 0.25rem;
        }

        .controls {
            display: flex;
            gap: 0.5rem;
        }

        .btn {
            font-family: 'Montserrat', sans-serif;
            padding: 0.625rem 1.25rem;
            border: 2px solid var(--cyan-dark);
            border-radius: 0.5rem;
            font-weight: 700;
            font-size: 0.875rem;
            letter-spacing: 0.05em;
            text-transform: uppercase;
            cursor: pointer;
            transition: all 300ms ease;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-family: 'Orbitron', sans-serif;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            position: relative;
            overflow: hidden;
        }

        .btn::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            background: radial-gradient(circle, rgba(0, 217, 255, 0.3), transparent);
            transform: translate(-50%, -50%);
            transition: width 300ms, height 300ms;
        }

        .btn:hover::before {
            width: 300px;
            height: 300px;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--cyan-dark), var(--cyan-medium));
            color: white;
            box-shadow: 0 0 20px rgba(0, 217, 255, 0.4);
        }

        .btn-primary:hover {
            background: linear-gradient(135deg, var(--cyan-medium), var(--cyan-bright));
            box-shadow: 0 0 30px rgba(0, 217, 255, 0.6);
            transform: translateY(-2px);
        }

        .btn-icon {
            width: 2.5rem;
            height: 2.5rem;
            padding: 0;
            justify-content: center;
            background: rgba(22, 52, 71, 0.6);
            color: var(--cyan-glow);
        }

        .btn-icon:hover {
            background: rgba(0, 217, 255, 0.2);
            box-shadow: 0 0 20px rgba(0, 217, 255, 0.4);
        }

        /* ========== KBD (Keyboard Keys) ========== */
        kbd {
            font-family: 'Orbitron', monospace;
            display: inline-block;
            padding: 0.5rem 1rem;
            background: rgba(0, 217, 255, 0.2);
            border: 2px solid var(--cyan-dark);
            border-radius: 0.5rem;
            color: var(--cyan-bright);
            font-weight: 700;
            text-align: center;
            box-shadow: 
                0 2px 0 var(--cyan-dark),
                0 0 10px rgba(0, 217, 255, 0.2);
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        /* ========== Difficulty Selector ========== */
        .difficulty-selector {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 1rem;
            margin: 3rem 0 2rem 0;
            padding-top: 1rem;
        }

        .difficulty-btn {
            padding: 1.5rem 1rem 1.25rem 1rem;
            background: linear-gradient(135deg, rgba(0, 151, 167, 0.2), rgba(0, 184, 212, 0.1));
            border: 2px solid var(--cyan-dark);
            border-radius: 0.75rem;
            cursor: pointer;
            transition: all 300ms ease;
            text-align: center;
            position: relative;
            overflow: visible;
            margin-top: 1rem;
        }

        .difficulty-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 2px;
            background: linear-gradient(90deg, transparent, var(--cyan-glow), transparent);
            transform: translateX(-100%);
            transition: transform 300ms;
        }

        .difficulty-btn:hover::before {
            transform: translateX(100%);
        }

        .difficulty-btn.selected {
            border-color: var(--cyan-bright);
            box-shadow: 0 0 20px rgba(0, 217, 255, 0.4);
            transform: scale(1.05);
        }

        .difficulty-btn.easy.selected {
            border-color: var(--green-bright);
            box-shadow: 0 0 20px rgba(34, 197, 94, 0.4);
        }

        .difficulty-btn.hard.selected {
            border-color: var(--red-bright);
            box-shadow: 0 0 20px rgba(239, 68, 68, 0.4);
        }

        .difficulty-icon {
            font-size: 2rem;
            margin-bottom: 0.5rem;
        }

        .difficulty-name {
            font-family: 'Montserrat', sans-serif;
            font-size: 1.125rem;
            font-weight: 800;
            margin-bottom: 0.5rem;
            letter-spacing: 0.05em;
            text-transform: uppercase;
            text-transform: uppercase;
        }

        .difficulty-desc {
            font-family: 'Work Sans', sans-serif;
            font-size: 0.75rem;
            color: var(--cyan-bright);
            margin-bottom: 0.75rem;
            font-weight: 400;
        }

        .difficulty-stats {
            font-family: 'Work Sans', sans-serif;
            display: flex;
            flex-direction: column;
            gap: 0.25rem;
            font-size: 0.7rem;
            color: var(--text-orange);
            font-weight: 500;
        }

        .difficulty-badge {
            font-family: 'Montserrat', sans-serif;
            position: absolute;
            top: -0.75rem;
            left: 50%;
            transform: translateX(-50%);
            background: var(--cyan-medium);
            color: white;
            padding: 0.375rem 0.75rem;
            border-radius: 0.375rem;
            font-size: 0.625rem;
            font-weight: 800;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
            white-space: nowrap;
            z-index: 10;
        }

        .difficulty-btn.easy .difficulty-badge {
            background: var(--green-bright);
        }

        .difficulty-btn.hard .difficulty-badge {
            background: var(--red-bright);
        }

        /* Continue with rest of styles... */
        .game-container {
            flex: 1;
            display: grid;
            grid-template-columns: 1fr 340px;
            gap: 0.75rem;
            min-height: 0;
        }

        .canvas-wrapper {
            background: rgba(10, 31, 46, 0.8);
            border-radius: 0.75rem;
            border: 2px solid var(--cyan-dark);
            box-shadow: 
                0 0 30px rgba(0, 217, 255, 0.2),
                inset 0 0 30px rgba(0, 217, 255, 0.05);
            position: relative;
            overflow: hidden;
            min-height: 300px;
            aspect-ratio: 16 / 9;
            width: 100vw;
            max-width: 100vw;
            overflow-x: hidden;
        }

        @supports not (aspect-ratio: 16 / 9) {
            .canvas-wrapper {
                min-height: 400px;
            }
        }

        #gameCanvas {
            width: 100%;
            height: 100%;
            display: block;
            touch-action: none;
        }

        .overlay {
            position: absolute;
            inset: 0;
            background: rgba(10, 31, 46, 0.98);
            backdrop-filter: blur(16px);
            display: flex;
            align-items: flex-start;
            justify-content: center;
            opacity: 0;
            pointer-events: none;
            transition: opacity 400ms ease;
            z-index: 100;
            overflow-y: auto;
            overflow-x: hidden;
            padding: 2rem 0;
        }

        .overlay.active {
            opacity: 1;
            pointer-events: all;
        }

        .overlay-content {
            text-align: center;
            padding: 2rem;
            max-width: 900px;
            width: 90%;
            animation: slideIn 600ms cubic-bezier(0.34, 1.56, 0.64, 1);
            margin: auto 0;
            min-height: min-content;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: scale(0.9) translateY(30px);
            }
            to {
                opacity: 1;
                transform: scale(1) translateY(0);
            }
        }

        .overlay-content {
            text-align: center;
            padding: 2rem;
            max-width: 100vw;
            width: 100vw;
            animation: slideIn 600ms cubic-bezier(0.34, 1.56, 0.64, 1);
            margin: auto 0;
            min-height: min-content;
            left: 0;
            right: 0;
        }
            letter-spacing: 0.08em;
            text-transform: uppercase;
        }

        .mission-text {
            font-family: 'Montserrat', sans-serif;
            font-size: 1.125rem;
            color: var(--text-orange);
            margin-bottom: 0.5rem;
            font-weight: 700;
            letter-spacing: 0.03em;
            text-transform: uppercase;
        }

        .flavor-text {
            font-family: 'Work Sans', sans-serif;
            font-size: 0.9375rem;
            color: var(--cyan-bright);
            font-style: italic;
            margin-bottom: 2rem;
            line-height: 1.6;
            font-weight: 400;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 1rem;
            margin: 2rem 0;
        }

        .stat-box {
            padding: 1.5rem 1rem;
            background: linear-gradient(135deg, rgba(0, 151, 167, 0.2), rgba(0, 184, 212, 0.1));
            border: 2px solid var(--cyan-dark);
            border-radius: 0.75rem;
            transition: all 300ms ease;
            position: relative;
            overflow: hidden;
        }

        .stat-box::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 2px;
            background: linear-gradient(90deg, transparent, var(--cyan-glow), transparent);
            animation: shimmer 2s infinite;
        }

        @keyframes shimmer {
            0%, 100% { transform: translateX(-100%); }
            50% { transform: translateX(100%); }
        }

        .stat-box:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 24px rgba(0, 217, 255, 0.3);
            border-color: var(--cyan-bright);
        }

        .stat-icon {
            font-size: 2rem;
            margin-bottom: 0.5rem;
            filter: drop-shadow(0 0 10px var(--cyan-glow));
        }

        .stat-label {
            font-family: 'Work Sans', sans-serif;
            font-size: 0.75rem;
            color: var(--cyan-bright);
            margin-bottom: 0.5rem;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            font-weight: 600;
        }

        .stat-value {
            font-family: 'Montserrat', sans-serif;
            font-size: 2rem;
            font-weight: 900;
            color: var(--cyan-glow);
            text-shadow: 0 0 10px rgba(0, 217, 255, 0.6);
        }

        .sidebar {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
            overflow-y: auto;
        }

        .sidebar::-webkit-scrollbar {
            width: 6px;
        }

        .sidebar::-webkit-scrollbar-track {
            background: rgba(0, 0, 0, 0.2);
        }

        .sidebar::-webkit-scrollbar-thumb {
            background: var(--cyan-dark);
            border-radius: 3px;
        }

        .card {
            background: rgba(10, 31, 46, 0.9);
            border-radius: 0.75rem;
            padding: 1.25rem;
            border: 2px solid var(--cyan-dark);
            box-shadow: 0 0 20px rgba(0, 217, 255, 0.2);
        }

        .card h3 {
            font-size: 1rem;
            margin-bottom: 1rem;
            color: var(--cyan-glow);
            text-transform: uppercase;
            letter-spacing: 0.1em;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .progress-container {
            margin-bottom: 1rem;
        }

        .progress-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 0.5rem;
            font-size: 0.875rem;
        }

        .progress-bar {
            height: 0.75rem;
            background: rgba(0, 0, 0, 0.4);
            border-radius: 0.5rem;
            overflow: hidden;
            border: 1px solid var(--cyan-dark);
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--cyan-medium), var(--cyan-glow));
            transition: width 300ms ease;
            position: relative;
            box-shadow: 0 0 10px rgba(0, 217, 255, 0.6);
        }

        .progress-fill::after {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
            animation: progressShimmer 2s infinite;
        }

        @keyframes progressShimmer {
            100% { left: 100%; }
        }

        .stat-item {
            display: flex;
            justify-content: space-between;
            padding: 0.75rem;
            background: rgba(0, 151, 167, 0.1);
            border-radius: 0.5rem;
            margin-bottom: 0.5rem;
            border: 1px solid rgba(0, 217, 255, 0.2);
        }

        .stat-item .label {
            font-family: 'Work Sans', sans-serif;
            color: var(--cyan-bright);
            font-weight: 500;
            font-size: 0.875rem;
        }

        .stat-item .value {
            font-family: 'Montserrat', sans-serif;
            color: var(--cyan-glow);
            font-weight: 800;
        }

        .achievement {
            display: flex;
            gap: 0.75rem;
            padding: 1rem;
            background: linear-gradient(135deg, rgba(255, 152, 0, 0.15), rgba(0, 184, 212, 0.1));
            border: 2px solid var(--orange-medium);
            border-radius: 0.75rem;
            margin-bottom: 0.75rem;
            transition: all 300ms ease;
        }

        .achievement:hover {
            transform: translateX(4px);
            box-shadow: 0 4px 16px rgba(255, 152, 0, 0.3);
            border-color: var(--orange-bright);
        }

        .achievement-icon {
            width: 2.5rem;
            height: 2.5rem;
            background: linear-gradient(135deg, var(--orange-medium), var(--orange-bright));
            border-radius: 0.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.25rem;
            flex-shrink: 0;
            box-shadow: 0 0 15px rgba(255, 152, 0, 0.5);
        }

        .achievement-details h4 {
            font-family: 'Montserrat', sans-serif;
            color: var(--orange-bright);
            font-size: 0.9375rem;
            font-weight: 700;
            margin-bottom: 0.25rem;
            letter-spacing: 0.03em;
        }

        .achievement-details p {
            font-family: 'Work Sans', sans-serif;
            color: var(--cyan-bright);
            font-size: 0.8125rem;
            font-weight: 400;
        }

        .achievement-popup {
            position: fixed;
            top: 1.5rem;
            right: 1.5rem;
            background: linear-gradient(135deg, var(--orange-dark), var(--orange-medium));
            color: white;
            padding: 1.25rem;
            border-radius: 0.75rem;
            border: 2px solid var(--orange-bright);
            box-shadow: 
                0 20px 40px rgba(0, 0, 0, 0.5),
                0 0 30px rgba(255, 152, 0, 0.4);
            max-width: 360px;
            z-index: 1000;
            opacity: 0;
            transform: translateX(400px);
            transition: all 400ms cubic-bezier(0.34, 1.56, 0.64, 1);
            pointer-events: none;
        }

        .achievement-popup.show {
            opacity: 1;
            transform: translateX(0);
            pointer-events: all;
        }

        .click-hint {
            position: absolute;
            background: rgba(0, 217, 255, 0.9);
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            font-size: 0.875rem;
            font-weight: 700;
            pointer-events: none;
            animation: floatAway 1s ease-out forwards;
            z-index: 200;
        }

        @keyframes floatAway {
            0% {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
            100% {
                opacity: 0;
                transform: translateY(-50px) scale(1.2);
            }
        }

        .interactive-stat {
            cursor: pointer;
            transition: all 200ms ease;
        }

        .interactive-stat:hover {
            transform: scale(1.05);
            background: rgba(0, 217, 255, 0.2) !important;
        }

        .interactive-stat:active {
            transform: scale(0.95);
        }

        .clickable-object {
            cursor: pointer;
        }

        .mission-brief {
            background: linear-gradient(135deg, rgba(0, 151, 167, 0.2), rgba(22, 52, 71, 0.4));
            padding: 1.5rem;
            border-radius: 0.75rem;
            border: 2px solid var(--cyan-dark);
            margin-top: 1.5rem;
            max-height: 50vh;
            overflow-y: auto;
        }

        .mission-brief h3 {
            color: var(--text-orange);
            font-size: 1rem;
            margin-bottom: 1rem;
            text-transform: uppercase;
        }

        .mission-brief p {
            font-size: 0.875rem;
            color: var(--cyan-bright);
            line-height: 1.6;
            margin-bottom: 0.75rem;
        }

        .mission-brief .highlight {
            color: var(--cyan-glow);
            font-weight: 700;
        }

        .mission-brief kbd {
            background: rgba(0, 217, 255, 0.2);
            padding: 0.25rem 0.5rem;
            border-radius: 0.25rem;
            border: 1px solid var(--cyan-dark);
            font-family: 'Courier New', monospace;
            font-size: 0.875rem;
            color: var(--cyan-glow);
        }

        .water-impact {
            background: linear-gradient(135deg, rgba(0, 184, 212, 0.2), rgba(0, 151, 167, 0.3));
            padding: 1rem;
            border-radius: 0.5rem;
            border: 2px solid var(--cyan-bright);
            margin-top: 1rem;
            text-align: center;
        }

        .water-impact .impact-label {
            font-size: 0.75rem;
            color: var(--cyan-bright);
            text-transform: uppercase;
            letter-spacing: 0.1em;
            margin-bottom: 0.5rem;
        }

        .water-impact .impact-value {
            font-size: 1.5rem;
            font-weight: 900;
            color: var(--cyan-glow);
            text-shadow: 0 0 15px rgba(0, 217, 255, 0.6);
        }

        .water-impact .impact-desc {
            font-size: 0.75rem;
            color: var(--orange-bright);
            margin-top: 0.5rem;
            font-style: italic;
        }

        .current-difficulty {
            display: inline-block;
            padding: 0.5rem 1rem;
            background: linear-gradient(135deg, rgba(0, 151, 167, 0.3), rgba(0, 184, 212, 0.2));
            border: 2px solid var(--cyan-medium);
            border-radius: 0.5rem;
            font-size: 0.875rem;
            margin-top: 1rem;
        }

        /* ========== Charity Footer ========== */
        .charity-footer {
            background: linear-gradient(135deg, #00b8d4 0%, #0097a7 100%);
            padding: 0.35rem 0.75rem;
            border-top: 2px solid #00d9ff;
            box-shadow: 0 -4px 12px 0 rgba(0, 217, 255, 0.2), 0 0 0 2px #00d9ff33, inset 0 1px 0 rgba(255,255,255,0.07);
            position: sticky;
            bottom: 0;
            overflow: visible;
            font-size: 0.85rem;
            color: #fff;
            z-index: 10000;
        }

        .charity-footer::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.1), transparent);
            animation: footerScan 4s infinite;
        }

        @keyframes footerScan {
            0%, 100% { left: -100%; }
            50% { left: 100%; }
        }

        .footer-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            max-width: 1400px;
            margin: 0 auto;
            position: relative;
            z-index: 1;
            gap: 2rem;
            flex-wrap: wrap;
        }

        .footer-brand {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .footer-logo {
            width: 50px;
            height: 50px;
            background: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
        }

        .footer-logo svg {
            width: 35px;
            height: 35px;
        }

        .footer-text {
            color: white;
        }

        .footer-text h3 {
            font-size: 1.25rem;
            font-weight: 900;
            margin-bottom: 0.25rem;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
            letter-spacing: 0.05em;
        }

        .footer-text p {
            font-size: 0.875rem;
            opacity: 0.95;
            font-weight: 500;
        }

        .footer-mission {
            flex: 1;
            max-width: 500px;
            color: white;
            font-size: 0.9375rem;
            line-height: 1.6;
            font-weight: 500;
            text-shadow: 0 1px 3px rgba(0, 0, 0, 0.2);
        }

        .footer-mission strong {
            color: #fff;
            font-weight: 700;
        }

        .footer-actions {
            display: flex;
            gap: 2rem;
            flex-wrap: wrap;
            margin-top: 2rem;
        }

        .footer-btn {
            padding: 1.25rem 2.5rem;
            border: 3px solid #fff;
            border-radius: 1rem;
            font-weight: 900;
            font-size: 1.25rem;
            cursor: pointer;
            transition: all 300ms ease;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            text-decoration: none;
            font-family: 'Orbitron', sans-serif;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            position: relative;
            overflow: hidden;
            box-shadow: 0 4px 18px rgba(0,217,255,0.25);
        }

        .footer-btn::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            background: radial-gradient(circle, rgba(255, 255, 255, 0.3), transparent);
            transform: translate(-50%, -50%);
            transition: width 300ms, height 300ms;
        }

        .footer-btn:hover::before {
            width: 300px;
            height: 300px;
        }

        .footer-btn:active {
            transform: translateY(-1px) scale(0.98);
        }

        .footer-btn-primary {
            background: linear-gradient(135deg, #ff9800, #f57c00);
            color: white;
            animation: pulseGlow 2s ease-in-out infinite;
        }

        @keyframes pulseGlow {
            0%, 100% {
                box-shadow: 0 4px 15px rgba(255, 152, 0, 0.4);
            }
            50% {
                box-shadow: 0 4px 25px rgba(255, 152, 0, 0.6);
            }
        }

        .footer-btn-primary:hover {
            background: linear-gradient(135deg, #ff6d00, #ff9800);
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(255, 152, 0, 0.6);
            animation: none;
        }

        .footer-btn-secondary {
            background: rgba(255, 255, 255, 0.95);
            color: var(--cyan-dark);
        }

        .footer-btn-secondary:hover {
            background: white;
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(255, 255, 255, 0.3);
        }

        .footer-impact {
            width: 100%;
            display: flex;
            justify-content: center;
            gap: 3rem;
            padding-top: 1.5rem;
            margin-top: 1.5rem;
            border-top: 1px solid rgba(255, 255, 255, 0.2);
            flex-wrap: wrap;
        }

        .impact-stat {
            text-align: center;
            color: white;
            cursor: pointer;
            padding: 0.75rem;
            border-radius: 0.5rem;
            transition: all 300ms ease;
            position: relative;
        }

        .impact-stat:hover {
            background: rgba(255, 255, 255, 0.1);
            transform: translateY(-3px);
        }

        .impact-stat:active {
            transform: translateY(-1px) scale(0.98);
        }

        .impact-stat-value {
            font-size: 2rem;
            font-weight: 900;
            text-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
            margin-bottom: 0.25rem;
        }

        .impact-stat-label {
            font-size: 0.8125rem;
            opacity: 0.9;
            text-transform: uppercase;
            letter-spacing: 0.1em;
        }

        .impact-tooltip {
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%) translateY(-10px);
            background: rgba(0, 0, 0, 0.95);
            color: white;
            padding: 0.75rem 1rem;
            border-radius: 0.5rem;
            font-size: 0.8125rem;
            white-space: nowrap;
            opacity: 0;
            pointer-events: none;
            transition: opacity 300ms ease;
            margin-bottom: 0.5rem;
            border: 2px solid var(--cyan-bright);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.5);
        }

        .impact-stat:hover .impact-tooltip {
            opacity: 1;
        }

        .impact-tooltip::after {
            content: '';
            position: absolute;
            top: 100%;
            left: 50%;
            transform: translateX(-50%);
            border: 6px solid transparent;
            border-top-color: var(--cyan-bright);
        }

        .footer-disclaimer {
            width: 100%;
            text-align: center;
            padding-top: 1rem;
            margin-top: 1rem;
            border-top: 1px solid rgba(255, 255, 255, 0.15);
            color: rgba(255, 255, 255, 0.8);
            font-size: 0.75rem;
            line-height: 1.6;
        }

        .footer-disclaimer a {
            color: white;
            text-decoration: underline;
            font-weight: 600;
        }

        .footer-disclaimer a:hover {
            color: var(--orange-bright);
        }

        @media (max-width: 1024px) {
            .game-container {
                grid-template-columns: 1fr;
            }
            
            .sidebar {
                flex-direction: row;
                overflow-x: auto;
                overflow-y: hidden;
            }
            
            .card {
                min-width: 300px;
            }

            .difficulty-selector {
                grid-template-columns: 1fr;
            }

            .footer-content {
                flex-direction: column;
                text-align: center;
            }

            .footer-brand {
                flex-direction: column;
            }

            .footer-mission {
                max-width: 100%;
            }

            .footer-actions {
                width: 100%;
                justify-content: center;
            }

            .footer-impact {
                gap: 1.5rem;
            }
        }

        @media (max-width: 640px) {
            .game-wrapper {
                padding: 0.5rem;
            }
            
            .title-block h1 {
                font-size: 1.25rem;
            }

            .subtitle {
                font-size: 0.75rem;
            }

            .tagline {
                font-size: 0.625rem;
            }

            .header-content {
                flex-direction: column;
                gap: 0.75rem;
            }

            .logo-section {
                gap: 0.75rem;
            }

            .water-drop-logo {
                width: 40px;
                height: 48px;
            }

            .controls {
                width: 100%;
                justify-content: center;
                flex-wrap: wrap;
            }

            .btn {
                padding: 0.5rem 1rem;
                font-size: 0.75rem;
            }

            .btn-icon {
                width: 44px;
                height: 44px;
                min-width: 44px;
                font-size: 1.25rem;
            }

            /* How to Play - mobile styles */
            #howToPlayOverlay kbd {
                min-width: 80px !important;
                font-size: 0.75rem;
                padding: 0.375rem 0.75rem !important;
            }

            #howToPlayOverlay h3 {
                font-size: 0.9375rem !important;
            }
            
            .overlay-content {
                padding: 1rem;
                max-width: 100%;
            }

            .overlay-content h2 {
                font-size: 1.75rem;
                margin-bottom: 0.75rem;
            }

            .mission-text {
                font-size: 0.875rem;
            }

            .flavor-text {
                font-size: 0.8125rem;
                margin-bottom: 1rem;
            }

            .difficulty-selector {
                gap: 0.75rem;
            }

            .difficulty-btn {
                padding: 1rem;
            }

            .difficulty-icon {
                font-size: 1.5rem;
            }

            .difficulty-name {
                font-size: 0.9375rem;
            }

            .difficulty-desc {
                font-size: 0.6875rem;
            }

            .difficulty-stats {
                font-size: 0.625rem;
            }
            
            .stats-grid {
                grid-template-columns: 1fr;
                gap: 0.75rem;
            }

            .achievement-popup {
                left: 0.5rem;
                right: 0.5rem;
                padding: 1rem;
                font-size: 0.875rem;
            }

            .card {
                min-width: 100%;
            }

            .footer-content {
                padding: 1rem;
            }

            .footer-logo {
                width: 35px;
                height: 42px;
            }

            .footer-impact {
                flex-direction: column;
                gap: 1rem;
            }

            .impact-stat {
                width: 100%;
            }

            .impact-stat-value {
                font-size: 1.5rem;
            }
        }

        /* Extra small phones */
        @media (max-width: 375px) {
            .title-block h1 {
                font-size: 1.125rem;
            }

            .overlay-content h2 {
                font-size: 1.5rem;
            }

            .btn {
                padding: 0.5rem 0.75rem;
                font-size: 0.6875rem;
            }

            .difficulty-btn {
                padding: 0.75rem;
            }
        }

        /* Landscape mobile */
        @media (max-width: 900px) and (max-height: 500px) {
            .header {
                padding: 0.5rem 1rem;
            }

            .header-content {
                flex-direction: row;
                gap: 1rem;
            }

            .game-wrapper {
                padding: 0.5rem;
            }

            .game-container {
                grid-template-columns: 1fr;
            }

            .sidebar {
                display: none; /* Hide sidebar in landscape mobile */
            }

            .overlay-content {
                padding: 1rem;
                max-height: calc(100vh - 2rem);
                overflow-y: auto;
            }

            .overlay-content h2 {
                font-size: 1.5rem;
                margin-bottom: 0.5rem;
            }

            .difficulty-selector {
                grid-template-columns: repeat(3, 1fr);
                gap: 0.5rem;
            }

            .difficulty-btn {
                padding: 0.75rem 0.5rem;
            }

            .difficulty-icon {
                font-size: 1.25rem;
                margin-bottom: 0.25rem;
            }

            .difficulty-name {
                font-size: 0.875rem;
            }

            .difficulty-desc,
            .difficulty-stats {
                display: none;
            }
        }

        /* Tablet landscape and small desktop */
        @media (min-width: 641px) and (max-width: 1024px) {
            .canvas-wrapper {
                min-height: 400px;
            }

            .overlay-content h2 {
                font-size: 2.5rem;
            }

            .difficulty-selector {
                grid-template-columns: repeat(3, 1fr);
            }

            .btn-text {
                display: inline !important;
            }
        }

        /* Large desktop optimization */
        @media (min-width: 1400px) {
            .game-container {
                grid-template-columns: 1fr 400px;
            }

            .canvas-wrapper {
                max-width: 1200px;
                margin: 0 auto;
            }

            .btn-text {
                display: inline !important;
            }
        }

        /* Medium desktop - show text */
        @media (min-width: 1024px) {
            .btn-text {
                display: inline !important;
            }
        }

        /* Touch-friendly improvements */
        @media (hover: none) and (pointer: coarse) {
            .btn,
            .difficulty-btn,
            .footer-btn,
            .impact-stat {
                min-height: 44px; /* iOS recommended touch target */
            }

            .btn-icon {
                min-width: 44px;
                min-height: 44px;
            }

            /* Prevent text selection on touch */
            .btn,
            .difficulty-btn,
            .overlay-content h2,
            .canvas-wrapper {
                -webkit-user-select: none;
                user-select: none;
            }
        }

        /* High DPI screens */
        @media (-webkit-min-device-pixel-ratio: 2), (min-resolution: 192dpi) {
            .water-drop-logo svg,
            .footer-logo svg {
                transform: translateZ(0); /* Improve rendering */
            }
        }

        /* Reduced motion preference */
        @media (prefers-reduced-motion: reduce) {
            *,
            *::before,
            *::after {
                animation-duration: 0.01ms !important;
                animation-iteration-count: 1 !important;
                transition-duration: 0.01ms !important;
            }

            .bg-animated::before {
                animation: none;
            }
        }
    </style>
        <style>
        /* Compact footer for charity: water links */
        .charitywater-links-footer {
            width: 100vw;
            background: #fff;
            color: #222;
            font-family: 'Montserrat', 'Arial', sans-serif;
            font-size: 1rem;
            border-top: 1px solid #e0e0e0;
            position: fixed;
            left: 0;
            bottom: 0;
            z-index: 1001;
            padding: 0.3rem 0;
            display: flex;
            justify-content: center;
            align-items: center;
            box-shadow: 0 -2px 8px rgba(0,0,0,0.04);
        }
        .charitywater-links-content {
            display: flex;
            align-items: center;
            gap: 0.7rem;
        }
        .charitywater-link-main, .charitywater-link-donate {
            color: #0097a7;
            text-decoration: none;
            font-weight: 600;
            letter-spacing: 0.01em;
            transition: color 0.2s;
        }
        .charitywater-link-main:hover, .charitywater-link-donate:hover {
            color: #00d9ff;
            text-decoration: underline;
        }
        .charitywater-footer-sep {
            color: #bbb;
            font-size: 1.1em;
            user-select: none;
        }
        @media (max-width: 600px) {
            .charitywater-links-footer {
                font-size: 0.9rem;
                padding: 0.18rem 0;
            }
            .charitywater-links-content {
                gap: 0.4rem;
            }
        }
        </style>
        <style>
        /* Footer Button under Mission Objectives */
        .charitywater-footer-btn-wrapper {
            width: 100%;
            display: flex;
            justify-content: center;
            margin: 1.2rem 0 0.5rem 0;
        }
        .charitywater-footer-btn {
            background: linear-gradient(90deg, #00d9ff 60%, #0097a7 100%);
            color: #fff;
            border-radius: 2rem;
            box-shadow: 0 2px 8px rgba(0,0,0,0.10);
            padding: 0.25rem 1.1rem 0.25rem 0.8rem;
            font-size: 1rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            text-decoration: none;
            transition: box-shadow 0.2s, background 0.2s;
        }
        .charitywater-footer-btn:hover {
            box-shadow: 0 4px 16px rgba(0,0,0,0.18);
            background: linear-gradient(90deg, #0097a7 60%, #00d9ff 100%);
        }
        .charitywater-footer-icon {
            font-size: 1.2em;
            margin-right: 0.1em;
        }
        .charitywater-footer-text {
            font-size: 0.95em;
            letter-spacing: 0.01em;
        }
        @media (max-width: 600px) {
            .charitywater-footer-btn {
                font-size: 0.85rem;
                padding: 0.18rem 0.7rem 0.18rem 0.5rem;
            }
            .charitywater-footer-icon {
                font-size: 1em;
            }
            .charitywater-footer-text {
                font-size: 0.85em;
            }
        }
        </style>
        <style>
        /* Floating Charity: Water Button */
        .charitywater-float-btn {
            position: fixed;
            right: 1.2vw;
            bottom: 1.2vw;
            z-index: 1000;
            background: linear-gradient(90deg, #00d9ff 60%, #0097a7 100%);
            color: #fff;
            border-radius: 2rem;
            box-shadow: 0 2px 8px rgba(0,0,0,0.10);
            padding: 0.25rem 0.9rem 0.25rem 0.6rem;
            font-size: 1rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            text-decoration: none;
            transition: box-shadow 0.2s, background 0.2s;
        }
        .charitywater-float-btn:hover {
            box-shadow: 0 4px 16px rgba(0,0,0,0.18);
            background: linear-gradient(90deg, #0097a7 60%, #00d9ff 100%);
        }
        .charitywater-float-icon {
            font-size: 1.2em;
            margin-right: 0.1em;
        }
        .charitywater-float-text {
            font-size: 0.95em;
            letter-spacing: 0.01em;
        }
        @media (max-width: 600px) {
            .charitywater-float-btn {
                font-size: 0.85rem;
                padding: 0.18rem 0.6rem 0.18rem 0.4rem;
                right: 2vw;
                bottom: 2vw;
            }
            .charitywater-float-icon {
                font-size: 1em;
            }
            .charitywater-float-text {
                font-size: 0.85em;
            }
        }
        </style>
        <style>
        /* Minimum Size Charity: Water Footer */
        .charity-footer {
            padding: 0;
            font-size: 0.4rem;
        }
        .charity-footer .footer-content {
            gap: 0;
            padding: 0;
        }
        .charity-footer .footer-brand h3 {
            font-size: 0.45rem;
            margin-bottom: 0;
        }
        .charity-footer .footer-brand p {
            font-size: 0.35rem;
            margin-bottom: 0;
        }
        .charity-footer .footer-mission {
            font-size: 0.35rem;
            margin-bottom: 0;
        }
        .charity-footer .footer-actions {
            gap: 0;
        }
        .charity-footer .footer-btn {
            font-size: 0.4rem;
            padding: 0.02rem 0.08rem;
        }
        .charity-footer .footer-impact {
            gap: 0;
            margin: 0;
        }
        .charity-footer .impact-stat-value {
            font-size: 0.35rem;
        }
        .charity-footer .impact-stat-label {
            font-size: 0.3rem;
        }
        .charity-footer .footer-disclaimer {
            font-size: 0.3rem;
            margin-top: 0;
        }
        .charity-footer .footer-logo svg {
            width: 7px;
            height: 8px;
        }
        </style>
        <style>
        /* Ultra-Compact Charity: Water Footer */
        .charity-footer {
            padding: 0.1rem 0.2rem;
            font-size: 0.55rem;
        }
        .charity-footer .footer-content {
            gap: 0.1rem;
            padding: 0.1rem 0;
        }
        .charity-footer .footer-brand h3 {
            font-size: 0.6rem;
            margin-bottom: 0.04rem;
        }
        .charity-footer .footer-brand p {
            font-size: 0.5rem;
            margin-bottom: 0.02rem;
        }
        .charity-footer .footer-mission {
            font-size: 0.5rem;
            margin-bottom: 0.05rem;
        }
        .charity-footer .footer-actions {
            gap: 0.1rem;
        }
        .charity-footer .footer-btn {
            font-size: 0.55rem;
            padding: 0.08rem 0.2rem;
        }
        .charity-footer .footer-impact {
            gap: 0.1rem;
            margin: 0.05rem 0;
        }
        .charity-footer .impact-stat-value {
            font-size: 0.5rem;
        }
        .charity-footer .impact-stat-label {
            font-size: 0.4rem;
        }
        .charity-footer .footer-disclaimer {
            font-size: 0.4rem;
            margin-top: 0.05rem;
        }
        .charity-footer .footer-logo svg {
            width: 12px;
            height: 14px;
        }
        </style>
        <style>
        /* Even Smaller Charity: Water Footer */
        .charity-footer {
            padding: 0.25rem 0.5rem;
            font-size: 0.7rem;
        }
        .charity-footer .footer-content {
            gap: 0.25rem;
            padding: 0.25rem 0;
        }
        .charity-footer .footer-brand h3 {
            font-size: 0.8rem;
            margin-bottom: 0.08rem;
        }
        .charity-footer .footer-brand p {
            font-size: 0.65rem;
            margin-bottom: 0.05rem;
        }
        .charity-footer .footer-mission {
            font-size: 0.65rem;
            margin-bottom: 0.1rem;
        }
        .charity-footer .footer-actions {
            gap: 0.25rem;
        }
        .charity-footer .footer-btn {
            font-size: 0.7rem;
            padding: 0.15rem 0.4rem;
        }
        .charity-footer .footer-impact {
            gap: 0.25rem;
            margin: 0.1rem 0;
        }
        .charity-footer .impact-stat-value {
            font-size: 0.7rem;
        }
        .charity-footer .impact-stat-label {
            font-size: 0.55rem;
        }
        .charity-footer .footer-disclaimer {
            font-size: 0.55rem;
            margin-top: 0.1rem;
        }
        .charity-footer .footer-logo svg {
            width: 22px;
            height: 26px;
        }
        </style>
        <style>
        /* Smaller Charity: Water Footer */
        .charity-footer {
            padding: 0.5rem 0.75rem;
            font-size: 0.85rem;
        }
        .charity-footer .footer-content {
            gap: 0.5rem;
            padding: 0.5rem 0;
        }
        .charity-footer .footer-brand h3 {
            font-size: 1rem;
            margin-bottom: 0.15rem;
        }
        .charity-footer .footer-brand p {
            font-size: 0.8rem;
            margin-bottom: 0.1rem;
        }
        .charity-footer .footer-mission {
            font-size: 0.8rem;
            margin-bottom: 0.2rem;
        }
        .charity-footer .footer-actions {
            gap: 0.5rem;
        }
        .charity-footer .footer-btn {
            font-size: 0.85rem;
            padding: 0.3rem 0.7rem;
        }
        .charity-footer .footer-impact {
            gap: 0.5rem;
            margin: 0.2rem 0;
        }
        .charity-footer .impact-stat-value {
            font-size: 1rem;
        }
        .charity-footer .impact-stat-label {
            font-size: 0.7rem;
        }
        .charity-footer .footer-disclaimer {
            font-size: 0.7rem;
            margin-top: 0.2rem;
        }
        .charity-footer .footer-logo svg {
            width: 32px;
            height: 38px;
        }
        </style>
        <style>
        /* Mission Protip Paragraph Refactor */
        .mission-protip {
            margin-top: 1rem;
            margin-bottom: 0.5rem;
            font-size: 1rem;
            color: var(--cyan-bright);
            font-style: italic;
        }
        </style>
        <style>
        /* Game Over Overlay Score Section Refactor */
        .gameover-difficulty {
            width: 100%;
            text-align: center;
            margin-bottom: 1rem;
        }
        .score-section {
            margin-top: 0.5rem;
            margin-bottom: 1.25rem;
        }
        .score-best-run {
            margin-top: 0.25rem;
            margin-bottom: 0.25rem;
        }
        .score-water-delivered {
            margin-top: 0.75rem;
        }
        </style>
</head>
<body>
    <audio id="hitSound" src="assets/hit.wav" preload="auto"></audio>
    <!-- Sound Effects -->
    <audio id="powerupSound" src="assets/powerup.wav" preload="auto"></audio>
    <audio id="missionCompleteSound" src="assets/mission-complete.mp3" preload="auto"></audio>
    <!-- Background Music -->
    <audio id="backgroundMusic" src="assets/tron-world.wav" preload="auto" loop></audio>
    <!-- Mission Complete Overlay -->
    <div id="missionCompleteOverlay" class="mission-complete-overlay" style="display:none;">
        <div class="mission-complete-bg-particles"></div>
        <div class="mission-complete-popup spectacular-glow">
            <div class="mission-complete-confetti"></div>
            <div class="mission-complete-sparkles"></div>
            <div class="mission-complete-rays"></div>
            <div class="mission-complete-stars"></div>
            <div class="mission-complete-title burst">🌊 MISSION COMPLETE! 🌊</div>
            <div class="mission-complete-subtitle">You are a HERO!</div>
            <div class="mission-complete-desc">Spectacular! You delivered clean water and completed your mission!</div>
            <div class="mission-complete-stats">
                <div class="stat-item">💧 Water Delivered</div>
                <div class="stat-item">🏃 Distance Covered</div>
                <div class="stat-item">⚡ Power Collected</div>
            </div>
            <div class="mission-complete-actions">
                <button id="missionCompleteRetry" class="mission-complete-btn btn-retry">🔄 Retry</button>
                <button id="missionCompleteMenu" class="mission-complete-btn btn-menu">🏠 Main Menu</button>
            </div>
        </div>
    </div>
    <style>
    .mission-complete-overlay {
        position: fixed;
        left: 0; top: 0; width: 100vw; height: 100vh;
        background: radial-gradient(circle at 50% 40%, #FFD700 0%, #1a1a1a 70%, #000 100%);
        z-index: 9999;
        display: flex;
        justify-content: center;
        align-items: center;
        animation: fadeInOverlay 0.6s ease-out;
        overflow: hidden;
    }
    @keyframes fadeInOverlay {
        from { opacity: 0; }
        to { opacity: 1; }
    }
    .mission-complete-bg-particles {
        position: absolute;
        width: 100%;
        height: 100%;
        pointer-events: none;
        z-index: 0;
    }
    .mission-complete-popup {
        background: linear-gradient(135deg, rgba(34,34,34,0.99) 0%, rgba(50,50,50,0.98) 100%);
        border-radius: 2.5rem;
        box-shadow: 0 8px 48px #FFD70099, inset 0 1px 0 rgba(255,255,255,0.1);
        padding: 3rem 2.5rem 2.5rem 2.5rem;
        text-align: center;
        position: relative;
        min-width: 340px;
        max-width: 90vw;
        animation: popInSpectacular 0.8s cubic-bezier(.68,-0.55,.27,1.55);
        border: 4px solid #FFD700;
        z-index: 10;
    }
    .spectacular-glow {
        box-shadow: 0 0 40px 12px #FFD700dd, 0 8px 48px #FFD70099, inset 0 1px 0 rgba(255,255,255,0.2);
        animation: glowPulseSpectacular 1.5s infinite alternate;
    }
    @keyframes glowPulseSpectacular {
        0% { box-shadow: 0 0 40px 12px #FFD700dd, 0 8px 48px #FFD70099, inset 0 1px 0 rgba(255,255,255,0.2); }
        50% { box-shadow: 0 0 60px 20px #FFD700ff, 0 12px 64px #FFD700cc, inset 0 1px 0 rgba(255,255,255,0.3); }
        100% { box-shadow: 0 0 80px 24px #FFD700ee, 0 8px 48px #FFD70099, inset 0 1px 0 rgba(255,255,255,0.2); }
    }
    .mission-complete-title.burst {
        position: relative;
        z-index: 2;
        animation: burstTitleSpectacular 0.8s cubic-bezier(.34,1.56,.64,1);
    }
    @keyframes burstTitleSpectacular {
        0% { transform: scale(0) rotateZ(-10deg); opacity: 0; }
        50% { transform: scale(1.15) rotateZ(2deg); }
        100% { transform: scale(1) rotateZ(0deg); opacity: 1; }
    }
    .mission-complete-subtitle {
        font-family: 'Montserrat', Arial, sans-serif;
        font-size: 1.8rem;
        font-weight: 800;
        color: #00d9ff;
        margin-top: -0.5rem;
        margin-bottom: 0.8rem;
        text-shadow: 0 2px 12px #00d9ff66, 0 0 4px #fff;
        animation: slideInSubtitle 0.8s ease-out 0.2s both;
        letter-spacing: 0.08em;
    }
    @keyframes slideInSubtitle {
        from { transform: translateY(-30px); opacity: 0; }
        to { transform: translateY(0); opacity: 1; }
    }
    .mission-complete-sparkles {
        position: absolute;
        left: 0; top: 0; width: 100%; height: 100%; pointer-events: none;
        z-index: 1;
    }
    .mission-complete-rays {
        position: absolute;
        left: 50%; top: 50%; width: 100%; height: 100%;
        transform: translate(-50%, -50%);
        pointer-events: none;
        z-index: 0;
    }
    .mission-complete-stars {
        position: absolute;
        left: 0; top: 0; width: 100%; height: 100%;
        pointer-events: none;
        z-index: 1;
    }
    @keyframes popInSpectacular {
        0% { transform: scale(0) rotateZ(-5deg); opacity: 0; }
        70% { transform: scale(1.08) rotateZ(1deg); opacity: 1; }
        100% { transform: scale(1) rotateZ(0deg); opacity: 1; }
    }
    .mission-complete-title {
        font-family: 'Montserrat', Arial, sans-serif;
        font-size: 3.2rem;
        font-weight: 900;
        color: #FFD700;
        margin-bottom: 0.3rem;
        letter-spacing: 0.06em;
        text-shadow: 0 2px 20px #FFD70099, 0 0 8px #fff, 0 4px 12px #FFD700;
        animation: pulseTitle 1.2s infinite alternate;
    }
    @keyframes pulseTitle {
        0% { text-shadow: 0 2px 20px #FFD70099, 0 0 8px #fff, 0 4px 12px #FFD700; }
        100% { text-shadow: 0 4px 32px #FFD700dd, 0 0 16px #fff, 0 6px 20px #FFD700; }
    }
    .mission-complete-desc {
        color: #00d9ff;
        font-size: 1.2rem;
        margin-top: 1.5rem;
        margin-bottom: 1.5rem;
        font-family: 'Montserrat', Arial, sans-serif;
        font-weight: 500;
        text-shadow: 0 1px 12px #00d9ff66;
        animation: slideIn 0.8s ease-out 0.3s both;
        letter-spacing: 0.02em;
    }
    @keyframes slideIn {
        from { transform: translateY(20px); opacity: 0; }
        to { transform: translateY(0); opacity: 1; }
    }
    .mission-complete-stats {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 1rem;
        margin: 1.5rem 0;
        padding: 1rem;
        background: rgba(0, 217, 255, 0.05);
        border-radius: 1rem;
        border: 1px solid rgba(0, 217, 255, 0.2);
    }
    .stat-item {
        font-size: 0.95rem;
        color: #00d9ff;
        font-weight: 600;
        padding: 0.5rem;
        animation: slideIn 0.8s ease-out both;
    }
    .stat-item:nth-child(2) { animation-delay: 0.4s; }
    .stat-item:nth-child(3) { animation-delay: 0.5s; }
    .mission-complete-actions {
        display: flex;
        gap: 1.5rem;
        justify-content: center;
        margin-top: 2rem;
        animation: slideIn 0.8s ease-out 0.5s both;
    }
    .mission-complete-btn {
        background: linear-gradient(135deg, #FFD700 0%, #FFC107 100%);
        color: #222;
        font-size: 1.15rem;
        font-weight: 700;
        border: 2px solid #fff;
        border-radius: 1.2rem;
        padding: 0.95rem 2rem;
        cursor: pointer;
        box-shadow: 0 4px 16px #FFD70055, inset 0 1px 0 rgba(255,255,255,0.4);
        transition: all 0.3s cubic-bezier(.34,1.56,.64,1);
        position: relative;
        overflow: hidden;
    }
    .mission-complete-btn::before {
        content: '';
        position: absolute;
        top: 0; left: -100%;
        width: 100%; height: 100%;
        background: rgba(255,255,255,0.3);
        transition: left 0.3s ease;
    }
    .mission-complete-btn:hover {
        background: linear-gradient(135deg, #fff 0%, #FFD700 100%);
        color: #FFD700;
        transform: scale(1.12) translateY(-3px);
        box-shadow: 0 6px 24px #FFD70077, inset 0 1px 0 rgba(255,255,255,0.6);
    }
    .mission-complete-btn:hover::before {
        left: 100%;
    }
    .mission-complete-confetti {
        position: absolute;
        left: 0; top: 0; width: 100%; height: 100%; pointer-events: none;
        z-index: 0;
    }
    </style>
    <!-- Removed missing tron-theme.mpg audio file -->
    <div class="bg-animated"></div>
    
    <div class="main-layout">
        <div class="game-wrapper flex-1">
        <!-- Header -->
        <header class="header">
            <div class="header-content">
                <div class="logo-section">
                    <div class="water-drop-logo">
                        <svg viewBox="0 0 100 120" xmlns="http://www.w3.org/2000/svg">
                            <defs>
                                <linearGradient id="dropGradient" x1="0%" y1="0%" x2="0%" y2="100%">
                                    <stop offset="0%" class="svg-stop-cyan" />
                                    <stop offset="100%" class="svg-stop-blue" />
                                </linearGradient>
                            </defs>
                            <path d="M 50 10 Q 70 40 70 70 Q 70 95 50 110 Q 30 95 30 70 Q 30 40 50 10 Z" 
                                  fill="url(#dropGradient)" 
                                  stroke="#00d9ff" 
                                  stroke-width="2"/>
                            <path d="M 50 30 Q 55 50 50 70 M 50 45 Q 45 55 40 65" 
                                  fill="none" 
                                  stroke="#006064" 
                                  stroke-width="2"/>
                            <ellipse cx="42" cy="35" rx="8" ry="12" fill="rgba(255, 255, 255, 0.4)"/>
                        </svg>
                    </div>
                    <div class="title-block">
                        <h1>LAST DROP</h1>
                        <div class="subtitle">A CHARITY: WATER RUN</div>
                        <div class="tagline">Every Drop Counts. Every Mile Matters.</div>
                    </div>
                </div>
                    <div class="runner-img-container">
                        <img src="assets/runner.png" alt="Runner" class="runner-img" id="runnerImg">
                    </div>
                <div class="controls">
                    <button class="btn btn-primary" id="howToPlayBtn" title="How to Play">
                        <span>❓</span>
                        <span class="btn-text visually-hidden">How to Play</span>
                    </button>
                    <button class="btn btn-icon" id="soundToggle" title="Toggle sound effects">
                        <span id="soundIcon">🔊</span>
                    </button>
                    <button class="btn btn-icon" id="musicToggle" title="Toggle background music">
                        <span id="musicIcon">🎵</span>
                    </button>
                    <button class="btn btn-icon" id="fullscreenToggle" title="Fullscreen">
                        <span>⛶</span>
                    </button>
                </div>
            </div>
        </header>

        <script>
        // Runner image interactive rotation
        const runnerImg = document.getElementById('runnerImg');
        if (runnerImg) {
            runnerImg.style.transition = 'transform 0.5s cubic-bezier(0.34,1.56,0.64,1)';
            runnerImg.addEventListener('click', () => {
                runnerImg.style.transform = 'rotate(360deg) scale(1.1)';
                setTimeout(() => {
                    runnerImg.style.transform = '';
                }, 500);
            });
        }
        </script>

        <!-- Game Container -->
        <div class="game-container">
            <!-- Canvas Area -->
            <div class="canvas-wrapper">
                <canvas id="gameCanvas"></canvas>

                <!-- Start Menu Overlay -->
                <div class="overlay active" id="menuOverlay">
                    <div class="overlay-content">
                        <h2>WASTELAND CIRCUIT</h2>
                        <p class="mission-text">📡 SEASON ONE: THE RUNNER'S CODE</p>
                        <p class="flavor-text">
                            In 2157, water is currency. You are Runner-00. 
                            Navigate the wasteland, deliver water drops, survive the drought.
                        </p>

                        <!-- Difficulty Selector -->
                        <div class="difficulty-selector-container">
                            <h3 class="difficulty-title">⚙️ SELECT DIFFICULTY</h3>
                            <div class="difficulty-selector">
                                <div class="difficulty-btn easy" data-difficulty="easy">
                                    <div class="difficulty-badge">Recommended</div>
                                    <div class="difficulty-icon">🌱</div>
                                    <div class="difficulty-name recruit">RECRUIT</div>
                                    <div class="difficulty-desc">Perfect for beginners</div>
                                    <div class="difficulty-stats">
                                        <div>• Speed: 80% Normal</div>
                                        <div>�� Obstacles: 60% Spawn Rate</div>
                                        <div>• Power-ups: 150% Duration</div>
                                        <div>• More water drops!</div>
                                    </div>
                                </div>

                                <div class="difficulty-btn normal selected" data-difficulty="normal">
                                    <div class="difficulty-badge">Balanced</div>
                                    <div class="difficulty-icon">⚡</div>
                                    <div class="difficulty-name runner">RUNNER</div>
                                    <div class="difficulty-desc">Standard challenge</div>
                                    <div class="difficulty-stats">
                                        <div>• Speed: 100% Normal</div>
                                        <div>• Obstacles: 100% Spawn Rate</div>
                                        <div>• Power-ups: 100% Duration</div>
                                        <div>• Classic experience</div>
                                    </div>
                                </div>

                                <div class="difficulty-btn hard" data-difficulty="hard">
                                    <div class="difficulty-badge">Expert</div>
                                    <div class="difficulty-icon">🔥</div>
                                    <div class="difficulty-name wasteland">WASTELAND</div>
                                    <div class="difficulty-desc">For true survivors</div>
                                    <div class="difficulty-stats">
                                        <div>• Speed: 130% Normal</div>
                                        <div>• Obstacles: 150% Spawn Rate</div>
                                        <div>• Power-ups: 70% Duration</div>
                                        <div>• Maximum challenge!</div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="stats-grid">
                            <div class="stat-box">
                                <div class="stat-icon">💧</div>
                                <div class="stat-label">Best Score</div>
                                <div class="stat-value" id="menuHighScore">0</div>
                            </div>
                            <div class="stat-box">
                                <div class="stat-icon">🏃</div>
                                <div class="stat-label">Miles Run</div>
                                <div class="stat-value" id="menuTotalMiles">0</div>
                            </div>
                            <div class="stat-box">
                                <div class="stat-icon">🏆</div>
                                <div class="stat-label">Missions</div>
                                <div class="stat-value" id="menuAchievements">0</div>
                            </div>
                        </div>

                        <button class="btn btn-primary btn-large" id="startButton">
                            ▶ BEGIN MISSION
                        </button>

                        <div class="mission-brief">
                            <h3>🎯 MISSION OBJECTIVES</h3>
                            <p>
                                <span class="highlight">NAVIGATE:</span> Avoid wasteland hazards<br>
                                <span class="highlight">COLLECT:</span> Gather water drops<br>
                                <span class="highlight">SURVIVE:</span> Use power-ups wisely<br>
                                <span class="highlight">DELIVER:</span> Every meter = 1 drop
                            </p>
                            <p class="mission-controls">
                                <strong>Controls:</strong><br>
                                <kbd>SPACE</kbd> or <kbd>↑</kbd> to jump<br>
                                <kbd>CLICK</kbd> drops for instant collection (+bonus!)<br>
                                <kbd>CLICK</kbd> power-ups to activate immediately<br>
                                <kbd>CLICK</kbd> obstacles to destroy (3 charges)<br>
                                <kbd>ESC</kbd> to pause
                            </p>
                            <p class="mission-protip">
                                                            <strong>💡 Pro Tip:</strong> Hover over objects to see what they do!
                            </p>
                        </div>
                    </div>
                </div>

                <!-- Game Over Overlay -->
                <div class="overlay" id="gameOverOverlay">
                    <div class="overlay-content">
                        <h2 class="overlay-title-failed">MISSION FAILED</h2>
                        <p class="mission-text">🔻 Water supply depleted</p>
                        
                                                <div class="current-difficulty gameover-difficulty" id="gameOverDifficulty">
                                                    Difficulty: RUNNER
                                                </div>

                                                <div class="score-section">
                                                    <div class="score-large" id="finalScore">0</div>
                                                    <p class="text-cyan-bright score-best-run">
                                                        Best Run: <strong id="finalHighScore" class="text-cyan-glow">0</strong> drops
                                                    </p>
                                                    <p class="text-cyan-bright score-water-delivered">
                                                        Water Delivered: <strong id="finalDrops" class="text-cyan-glow">0</strong> 💧
                                                    </p>
                                                </div>
                        
                        <div class="water-impact">
                            <div class="impact-label">Total Impact</div>
                            <div class="impact-value" id="totalImpact">0 Liters</div>
                            <div class="impact-desc">Clean water provided</div>
                        </div>

                        <div class="flex-center">
                            <button class="btn btn-primary" id="playAgainButton">
                                🔄 RETRY MISSION
                            </button>
                            <button class="btn btn-icon btn-medium" id="backToMenuButton">
                                🏠 BASE
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Pause Overlay -->
                <div class="overlay" id="pauseOverlay">
                    <div class="overlay-content">
                        <h2>⏸ MISSION PAUSED</h2>
                        <div class="current-difficulty" id="pauseDifficulty">
                            Difficulty: RUNNER
                        </div>
                        <p class="text-cyan-bright mt-2 mb-2">Press ESC or Resume to continue</p>
                        <button class="btn btn-primary" id="resumeButton">
                            ▶ RESUME MISSION
                        </button>
                    </div>
                </div>

                <!-- How to Play Overlay -->
                <div class="overlay" id="howToPlayOverlay">
                    <div class="overlay-content overlay-content-custom">
                        <button class="btn btn-icon btn-close-howto" id="closeHowToPlayX" title="Close">
                            ✕
                        </button>
                        <h2>📖 HOW TO PLAY</h2>
                        <p class="mission-text">Master the Wasteland Circuit</p>
                        <p class="hint-cyan-medium">
                            Press <kbd class="kbd-hint">ESC</kbd> or click <strong class="strong-cyan-bright">✕</strong> to close
                        </p>

                        <div class="hint-block">
                            <!-- Basic Controls -->
                            <div class="hint-section">
                                <h3 class="hint-title-cyan">
                                    🎮 <span>Basic Controls</span>
                                </h3>
                                <div class="hint-grid">
                                    <div class="hint-flex">
                                        <kbd class="kbd-action">SPACE / ↑</kbd>
                                        <span class="span-cyan-bright">Jump over obstacles</span>
                                    </div>
                                    <div class="hint-flex">
                                        <kbd class="kbd-action">CLICK / TAP</kbd>
                                        <span class="span-cyan-bright">Interact with objects</span>
                                    </div>
                                    <div class="hint-flex">
                                        <kbd class="kbd-action">ESC</kbd>
                                        <span class="span-cyan-bright">Pause game</span>
                                    </div>
                                    <div class="hint-flex">
                                        <kbd class="kbd-action">HOVER</kbd>
                                        <span class="span-cyan-bright">See object info (desktop)</span>
                                    </div>
                                </div>
                            </div>

                            <!-- Click Mechanics -->
                            <div class="card-orange">
                                <h3 class="card-title-orange">
                                    👆 <span>Click Mechanics</span>
                                </h3>
                                <div class="card-grid-cyan">
                                    <div>
                                        <strong class="card-strong-cyan">💧 Water Drops:</strong>
                                        Click to collect instantly + <span class="card-strong-orange">bonus points!</span>
                                    </div>
                                    <div>
                                        <strong class="card-strong-cyan">⚡ Power-ups:</strong>
                                        Click to activate immediately
                                    </div>
                                    <div>
                                        <strong class="card-strong-cyan">🚫 Obstacles:</strong>
                                        Click to destroy using Click Power (requires charges)
                                    </div>
                                    <div class="card-combo-box">
                                        <strong class="card-strong-orange">🔋 Click Power System:</strong><br>
                                        • Start with 3 charges<br>
                                        • Each obstacle click uses 1 charge<br>
                                        • Recharge by collecting water drops<br>
                                        • Visual indicator shows remaining charges
                                    </div>
                                </div>
                            </div>

                            <!-- Power-Ups -->
                            <div class="card-cyan">
                                <h3 class="card-title-cyan">
                                    ⚡ <span>Power-Ups</span>
                                </h3>
                                <div class="card-grid-cyan card-powerups-grid">
                                    <div class="card-powerup-flex">
                                        <span class="card-powerup-icon">🛡️</span>
                                        <div>
                                            <strong class="card-strong-cyan">Shield:</strong> Protects you from one obstacle hit<br>
                                            <small class="card-small-cyan">Duration: 10 seconds</small>
                                        </div>
                                    </div>
                                    <div class="card-powerup-flex">
                                        <span class="card-powerup-icon">⚡</span>
                                        <div>
                                            <strong class="card-strong-cyan">Speed Boost:</strong> Increases game speed for higher score multiplier<br>
                                            <small class="card-small-cyan">Duration: 8 seconds</small>
                                        </div>
                                    </div>
                                    <div class="card-powerup-flex">
                                        <span class="card-powerup-icon">🧲</span>
                                        <div>
                                            <strong class="card-strong-cyan">Magnet:</strong> Auto-collects nearby water drops<br>
                                            <small class="card-small-cyan">Duration: 12 seconds</small>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Scoring -->
                            <div class="card-orange-light">
                                <h3 class="card-title-orange">
                                    🏆 <span>Scoring System</span>
                                </h3>
                                <div class="card-grid-cyan card-scoring-grid">
                                    <div>• <strong class="card-strong-cyan">Water Drops:</strong> 10 points each (15 if clicked)</div>
                                    <div>• <strong class="card-strong-cyan">Distance:</strong> 1 point per meter traveled</div>
                                    <div>• <strong class="card-strong-cyan">Combos:</strong> Collect drops quickly for multipliers!</div>
                                    <div>• <strong class="card-strong-cyan">Difficulty Bonus:</strong> Higher difficulty = more points</div>
                                    <div class="card-combo-box card-combo-box-orange">
                                        <strong class="card-strong-orange">💥 Combo System:</strong><br>
                                        Collect multiple drops rapidly to activate combos<br>
                                        • 2x Combo → 3x Combo → 5x Combo<br>
                                        • Timer resets with each collection
                                    </div>
                                </div>
                            </div>

                            <!-- Difficulty Modes -->
                            <div class="card-cyan card-difficulty-modes">
                                <h3 class="card-title-cyan">
                                    ⚙️ <span>Difficulty Modes</span>
                                </h3>
                                <div class="card-grid-cyan card-difficulty-grid">
                                    <div>
                                        <strong class="card-strong-green">🌱 SURVIVOR:</strong> Perfect for beginners<br>
                                        <small class="card-small-cyan">Slower speed, fewer obstacles, more power-ups</small>
                                    </div>
                                    <div>
                                        <strong class="card-strong-cyan">🏃 RUNNER:</strong> Balanced challenge<br>
                                        <small class="card-small-cyan">Standard difficulty for regular players</small>
                                    </div>
                                    <div>
                                        <strong class="card-strong-red">⚡ LEGEND:</strong> Ultimate test<br>
                                        <small class="card-small-cyan">Maximum speed, more obstacles, fewer power-ups</small>
                                    </div>
                                </div>
                            </div>

                            <!-- Pro Tips -->
                            <div class="card-orange-light card-pro-tips">
                                <h3 class="card-title-orange">
                                    💡 <span>Pro Tips</span>
                                </h3>
                                <div class="card-grid-cyan card-pro-tips-grid">
                                    <div>✓ Click drops for bonus points instead of just jumping through them</div>
                                    <div>✓ Save Click Power charges for emergency situations</div>
                                    <div>✓ Chain drop collections quickly to build combo multipliers</div>
                                    <div>✓ Use shields before attempting risky maneuvers</div>
                                    <div>✓ Magnet power-ups are great for maintaining combos</div>
                                    <div>✓ Every meter traveled = 1 drop of clean water delivered!</div>
                                    <div class="card-pro-tips-goal">
                                        <strong class="card-strong-orange">🎯 Goal:</strong> The longer you survive and more drops you collect, the more water you deliver to communities in need!
                                    </div>
                                </div>
                            </div>
                        </div>

                        <button class="btn btn-primary" id="closeHowToPlay" style="margin-top: 1.5rem; font-size: 1rem; padding: 0.875rem 2rem;">
                            ✓ GOT IT!
                        </button>
                    </div>
                </div>
            </div>

            <!-- Sidebar -->
            <aside class="sidebar">
                <!-- Mission Stats Card -->
                <div class="card">
                    <h3 class="mission-data-header">
                        <img src="assets/charity_water_logo.png" alt="Charity Water Logo" class="mission-data-logo"> 
                        <span>📊 MISSION DATA</span>
                    </h3>
                    <div class="current-difficulty" id="sidebarDifficulty" style="width: 100%; text-align: center; margin-bottom: 1rem;">
                        Mode: RUNNER
                    </div>
                    </div>
                    <div class="progress-container" style="max-height: 30vh; overflow-y: auto;">
                        <div class="progress-container-scroll">
                            <div class="progress-header">
                            <span style="color: var(--cyan-bright);">Current Run</span>
                            <strong id="currentScore" style="color: var(--cyan-glow);">0</strong>
                        </div>
                        <div class="progress-bar">
                            <div class="progress-fill" id="scoreProgress" style="width: 0%"></div>
                        </div>
                    </div>

                    <div class="stat-item interactive-stat" id="statGames" title="Click me!">
                        <span class="label">Missions Attempted</span>
                        <strong class="value" id="gamesPlayed">0</strong>
                    </div>
                    <div class="stat-item interactive-stat" id="statDistance" title="Click me!">
                        <span class="label">Total Distance</span>
                        <strong class="value" id="totalDistance">0m</strong>
                    </div>
                    <div class="stat-item interactive-stat" id="statDrops" title="Click me!">
                        <span class="label">Water Drops</span>
                        <strong class="value" id="totalDrops">0</strong>
                    </div>
                    <div class="stat-item interactive-stat" id="statRun" title="Click me!">
                        <span class="label">Best Run</span>
                        <strong class="value" id="longestRun">0m</strong>
                    </div>

                    <div class="water-impact">
                        <div class="impact-label">Miles = Drops</div>
                        <div class="impact-value" id="impactCounter">0 L</div>
                        <div class="impact-desc">Clean water provided</div>
                    </div>
                </div>

                <!-- Achievements Card -->
                <div class="card">
                    <h3>🏆 UNLOCKED MISSIONS</h3>
                    <div id="achievementList" style="max-height: 250px; overflow-y: auto;">
                        <p style="text-align: center; color: var(--cyan-bright); padding: 2rem 0; font-size: 0.875rem;">
                            Complete missions to unlock achievements
                        </p>
                    </div>
                </div>

                <!-- Equipment Card -->
                <div class="card">
                    <h3>⚡ FIELD EQUIPMENT</h3>
                    <div class="stat-item">
                        <span>🛡️ HYDRO-SHIELD</span>
                        <span style="font-size: 0.75rem; color: var(--cyan-bright);">Block hazard</span>
                    </div>
                    <div class="stat-item">
                        <span>⚡ TURBO-CELL</span>
                        <span style="font-size: 0.75rem; color: var(--cyan-bright);">2x speed</span>
                    </div>
                    <div class="stat-item">
                        <span>🧲 AQUA-MAGNET</span>
                        <span style="font-size: 0.75rem; color: var(--cyan-bright);">Auto-collect</span>
                    </div>
                </div>

                <!-- Skins Card -->
                <div class="card">
                    <h3>🎨 UNLOCKED SKINS</h3>
                    <div id="skinsList" style="display:flex; gap:0.5rem; flex-wrap:wrap; margin-top:0.75rem;"></div>
                </div>
            </aside>
        </div>
    </div>

    <!-- Charity: Water Footer -->
    <footer class="charitywater-footer">
        <div class="charitywater-footer-content">
            <img src="assets/charity_water_logo.png" alt="Charity: Water Logo" class="charitywater-footer-logo">
            <div class="charitywater-footer-links">
                <a href="https://www.charitywater.org/" target="_blank" rel="noopener noreferrer" class="charitywater-link">Visit charity: water</a>
                <a href="https://www.charitywater.org/donate" target="_blank" rel="noopener noreferrer" class="charitywater-link charitywater-donate">Donate</a>
            </div>
        </div>
    </footer>
    <style>
    .charitywater-footer {
        width: 100%;
        background: #222;
        color: #fff;
        display: flex;
        justify-content: center;
        align-items: center;
        padding: 1rem 0;
        position: fixed;
        left: 0;
        bottom: 0;
        z-index: 100;
        box-shadow: 0 -2px 12px rgba(0,0,0,0.12);
        font-family: 'Montserrat', Arial, sans-serif;
    }
    .charitywater-footer-content {
        display: flex;
        align-items: center;
        gap: 1.5rem;
    }
    .charitywater-footer-logo {
        height: 32px;
        margin-right: 1rem;
    }
    .charitywater-footer-links {
        display: flex;
        gap: 1.25rem;
    }
    .charitywater-link {
        color: #FFD700;
        text-decoration: none;
        font-weight: 600;
        font-size: 1.1rem;
        transition: color 0.2s;
    }
    .charitywater-link:hover {
        color: #fff;
        text-decoration: underline;
    }
    .charitywater-donate {
        background: #FFD700;
        color: #222;
        padding: 0.25rem 1rem;
        border-radius: 6px;
        font-weight: 700;
        margin-left: 0.5rem;
        box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        transition: background 0.2s, color 0.2s;
    }
    .charitywater-donate:hover {
        background: #fff;
        color: #222;
    }
    </style>
    </div>

    <!-- Achievement Popup -->
    <div class="achievement-popup" id="achievementPopup">
        <div style="display: flex; gap: 1rem;">
            <div style="font-size: 2rem;">🏆</div>
            <div>
                <div style="font-size: 0.75rem; font-weight: 700; text-transform: uppercase; opacity: 0.9; margin-bottom: 0.25rem;">MISSION UNLOCKED!</div>
                <div style="font-size: 1.125rem; font-weight: 700; margin-bottom: 0.25rem;" id="achievementTitle">Title</div>
                <div style="font-size: 0.875rem; opacity: 0.85;" id="achievementDesc">Description</div>
            </div>
        </div>
    </div>

    <script>
        // ==================== Difficulty Settings ====================
        const DIFFICULTY_SETTINGS = {
            easy: {
                name: 'RECRUIT',
                speedMultiplier: 0.8,
                obstacleSpawnRate: 1.5,  // Higher = slower spawning
                dropSpawnRate: 0.7,      // Lower = more drops
                powerupDuration: 1.5,
                gravity: 0.55,
                jumpForce: -13.5,
                color: '#22c55e'
            },
            normal: {
                name: 'RUNNER',
                speedMultiplier: 1.0,
                obstacleSpawnRate: 1.0,
                dropSpawnRate: 1.0,
                powerupDuration: 1.0,
                gravity: 0.65,
                jumpForce: -13.5,
                color: '#00d9ff'
            },
            hard: {
                name: 'WASTELAND',
                speedMultiplier: 1.3,
                obstacleSpawnRate: 0.65,  // Spawn obstacles faster
                dropSpawnRate: 1.3,       // Fewer drops
                powerupDuration: 0.7,
                gravity: 0.7,
                jumpForce: -14,
                color: '#ef4444'
            }
        };
        // ==================== Play Sound Effects ====================
        function playSound(id) {
            const audio = document.getElementById(id);
            if (audio) {
                audio.currentTime = 0;
                audio.play().catch(e => {
                    // User interaction required or audio blocked
                    console.debug('Audio play delayed:', id);
                });
            }
        }

        // ==================== Tron Music Player ====================
        class TronMusicPlayer {
            constructor() {
                this.ctx = null;
                this.isPlaying = false;
                this.nextNoteTime = 0;
                this.currentNote = 0;
                this.tempo = 120; // BPM
                this.lookahead = 25; // ms
                this.scheduleAheadTime = 0.1; // seconds
                this.timerID = null;
                
                // Tron-style synth sequence (arpeggiated pattern)
                this.melodyNotes = [
                    { note: 'E4', duration: 0.25 },
                    { note: 'B4', duration: 0.25 },
                    { note: 'E5', duration: 0.25 },
                    { note: 'B4', duration: 0.25 },
                    { note: 'C#5', duration: 0.25 },
                    { note: 'B4', duration: 0.25 },
                    { note: 'A4', duration: 0.25 },
                    { note: 'B4', duration: 0.25 },
                    { note: 'E4', duration: 0.25 },
                    { note: 'B4', duration: 0.25 },
                    { note: 'E5', duration: 0.25 },
                    { note: 'B4', duration: 0.25 },
                    { note: 'G#4', duration: 0.25 },
                    { note: 'B4', duration: 0.25 },
                    { note: 'E5', duration: 0.25 },
                    { note: 'B4', duration: 0.25 }
                ];
                
                // Bass line pattern
                this.bassNotes = [
                    { note: 'E2', duration: 1 },
                    { note: 'E2', duration: 1 },
                    { note: 'A2', duration: 1 },
                    { note: 'B2', duration: 1 }
                ];
                
                this.currentBassNote = 0;
                
                // Note frequencies
                this.noteFrequencies = {
                    'E2': 82.41, 'A2': 110.00, 'B2': 123.47,
                    'E4': 329.63, 'G#4': 415.30, 'A4': 440.00,
                    'B4': 493.88, 'C#5': 554.37, 'E5': 659.25
                };
            }

            play() {
                if (this.isPlaying) return;
                
                try {
                    this.ctx = new (window.AudioContext || window.webkitAudioContext)();
                    this.isPlaying = true;
                    this.currentNote = 0;
                    this.currentBassNote = 0;
                    this.nextNoteTime = this.ctx.currentTime;
                    this.scheduler();
                } catch (e) {
                    console.error('Audio context error:', e);
                }
            }

            stop() {
                this.isPlaying = false;
                if (this.timerID) {
                    clearTimeout(this.timerID);
                    this.timerID = null;
                }
                if (this.ctx) {
                    this.ctx.close();
                    this.ctx = null;
                }
            }

            scheduler() {
                if (!this.isPlaying) return;
                
                while (this.nextNoteTime < this.ctx.currentTime + this.scheduleAheadTime) {
                    this.scheduleNote(this.currentNote, this.nextNoteTime);
                    this.nextNote();
                }
                
                this.timerID = setTimeout(() => this.scheduler(), this.lookahead);
            }

            nextNote() {
                const secondsPerBeat = 60.0 / this.tempo;
                const noteData = this.melodyNotes[this.currentNote];
                this.nextNoteTime += noteData.duration * secondsPerBeat;
                
                this.currentNote = (this.currentNote + 1) % this.melodyNotes.length;
                
                // Advance bass note every 4 melody notes
                if (this.currentNote % 4 === 0) {
                    this.currentBassNote = (this.currentBassNote + 1) % this.bassNotes.length;
                }
            }

            scheduleNote(noteIndex, time) {
                const melody = this.melodyNotes[noteIndex];
                const bass = this.bassNotes[this.currentBassNote];
                
                // Create lead synth (higher pitched, saw wave for that Tron sound)
                const leadOsc = this.ctx.createOscillator();
                const leadGain = this.ctx.createGain();
                const leadFilter = this.ctx.createBiquadFilter();
                
                leadOsc.type = 'sawtooth';
                leadOsc.frequency.value = this.noteFrequencies[melody.note];
                
                leadFilter.type = 'lowpass';
                leadFilter.frequency.value = 2000;
                leadFilter.Q.value = 5;
                
                leadOsc.connect(leadFilter);
                leadFilter.connect(leadGain);
                leadGain.connect(this.ctx.destination);
                
                leadGain.gain.value = 0;
                leadGain.gain.setValueAtTime(0, time);
                leadGain.gain.linearRampToValueAtTime(0.08, time + 0.005);
                leadGain.gain.exponentialRampToValueAtTime(0.01, time + melody.duration * 0.5);
                
                leadOsc.start(time);
                leadOsc.stop(time + melody.duration * 0.5);
                
                // Create bass synth (lower, sine wave for sub-bass)
                const bassOsc = this.ctx.createOscillator();
                const bassGain = this.ctx.createGain();
                
                bassOsc.type = 'sine';
                bassOsc.frequency.value = this.noteFrequencies[bass.note];
                
                bassOsc.connect(bassGain);
                bassGain.connect(this.ctx.destination);
                
                bassGain.gain.value = 0;
                bassGain.gain.setValueAtTime(0, time);
                bassGain.gain.linearRampToValueAtTime(0.15, time + 0.01);
                bassGain.gain.exponentialRampToValueAtTime(0.01, time + bass.duration * 0.25);
                
                // Only play bass on downbeats
                if (noteIndex % 4 === 0) {
                    bassOsc.start(time);
                    bassOsc.stop(time + bass.duration * 0.25);
                }
            }
        }

        // ==================== Game Manager ====================
        class GameManager {
            constructor() {
                this.state = 'menu';
                this.score = 0;
                this.highScore = 0;
                this.totalDrops = 0;
                this.soundEnabled = true;
                this.musicEnabled = true;
                this.difficulty = 'normal';
                this.achievements = [];
                this.skins = [
                    { id: 'default', name: 'Default', color: ['#00d9ff','#0097a7','#006064'], unlocked: true },
                    { id: 'sunset', name: 'Sunset', color: ['#ff9800','#ff7043','#d84315'], unlocked: false },
                    { id: 'gold', name: 'Golden', color: ['#FFD700','#FFC107','#FFB300'], unlocked: false }
                ];
                this.selectedSkin = 'default';
                this.stats = {
                    gamesPlayed: 0,
                    totalDistance: 0,
                    totalDrops: 0,
                    totalJumps: 0,
                    longestRun: 0
                };
                this.musicPlayer = null;
                this.loadGame();
                this.setupDifficultySelector();
            }

            setupDifficultySelector() {
                const buttons = document.querySelectorAll('.difficulty-btn');
                buttons.forEach(btn => {
                    btn.addEventListener('click', () => {
                        buttons.forEach(b => b.classList.remove('selected'));
                        btn.classList.add('selected');
                        this.difficulty = btn.dataset.difficulty;
                        localStorage.setItem('lastdrop_difficulty', this.difficulty);
                    });
                });

                // Load saved difficulty
                const saved = localStorage.getItem('lastdrop_difficulty');
                if (saved && DIFFICULTY_SETTINGS[saved]) {
                    this.difficulty = saved;
                    buttons.forEach(btn => {
                        btn.classList.toggle('selected', btn.dataset.difficulty === saved);
                    });
                }
            }

            getDifficultySettings() {
                return DIFFICULTY_SETTINGS[this.difficulty];
            }

            updateDifficultyDisplay() {
                const settings = this.getDifficultySettings();
                const displays = [
                    'sidebarDifficulty',
                    'pauseDifficulty',
                    'gameOverDifficulty'
                ];
                displays.forEach(id => {
                    const el = document.getElementById(id);
                    if (el) {
                        el.textContent = `Mode: ${settings.name}`;
                        el.style.borderColor = settings.color;
                    }
                });
            }

            loadGame() {
                try {
                    this.highScore = parseInt(localStorage.getItem('lastdrop_highScore') || '0');
                    this.totalDrops = parseInt(localStorage.getItem('lastdrop_totalDrops') || '0');
                    this.soundEnabled = localStorage.getItem('lastdrop_soundEnabled') !== 'false';
                    this.musicEnabled = localStorage.getItem('lastdrop_musicEnabled') !== 'false';
                    this.difficulty = localStorage.getItem('lastdrop_difficulty') || 'normal';
                    
                    const stats = localStorage.getItem('lastdrop_stats');
                    if (stats) this.stats = JSON.parse(stats);
                    
                    const achievements = localStorage.getItem('lastdrop_achievements');
                    if (achievements) this.achievements = JSON.parse(achievements);
                    const skins = localStorage.getItem('lastdrop_skins');
                    if (skins) {
                        const parsed = JSON.parse(skins);
                        // merge unlocked state
                        this.skins.forEach(s => {
                            const found = parsed.find(p => p.id === s.id);
                            if (found) s.unlocked = found.unlocked;
                        });
                    }
                    const sel = localStorage.getItem('lastdrop_selectedSkin');
                    if (sel) this.selectedSkin = sel;
                } catch (e) {
                    console.error('Load error:', e);
                }
            }

            saveGame() {
                try {
                    localStorage.setItem('lastdrop_highScore', this.highScore);
                    localStorage.setItem('lastdrop_totalDrops', this.totalDrops);
                    localStorage.setItem('lastdrop_soundEnabled', this.soundEnabled);
                    localStorage.setItem('lastdrop_musicEnabled', this.musicEnabled);
                    localStorage.setItem('lastdrop_difficulty', this.difficulty);
                    localStorage.setItem('lastdrop_stats', JSON.stringify(this.stats));
                    localStorage.setItem('lastdrop_achievements', JSON.stringify(this.achievements));
                    localStorage.setItem('lastdrop_skins', JSON.stringify(this.skins.map(s => ({ id: s.id, unlocked: s.unlocked }))));
                    localStorage.setItem('lastdrop_selectedSkin', this.selectedSkin);
                    // Notify UI that skins state changed
                    try { window.dispatchEvent(new CustomEvent('skinsUpdated')); } catch(e){}
                } catch (e) {
                    console.error('Save error:', e);
                }
            }

            toggleSound() {
                this.soundEnabled = !this.soundEnabled;
                document.getElementById('soundIcon').textContent = this.soundEnabled ? '🔊' : '���';
                this.saveGame();
            }

            toggleMusic() {
                this.musicEnabled = !this.musicEnabled;
                document.getElementById('musicIcon').textContent = this.musicEnabled ? '🎵' : '🔇';
                
                if (this.musicEnabled) {
                    this.startBackgroundMusic();
                } else {
                    this.stopBackgroundMusic();
                }
                
                this.saveGame();
            }

            startBackgroundMusic() {
                try {
                    const bgMusic = document.getElementById('backgroundMusic');
                    if (bgMusic) {
                        bgMusic.volume = 0.3; // Set volume to 30%
                        bgMusic.currentTime = 0;
                        const playPromise = bgMusic.play();
                        if (playPromise !== undefined) {
                            playPromise.catch(e => {
                                // Autoplay was prevented, will play on first user interaction
                                console.debug('Music will start on user interaction');
                            });
                        }
                    }
                } catch (e) {
                    console.error('Music error:', e);
                }
            }

            stopBackgroundMusic() {
                try {
                    const bgMusic = document.getElementById('backgroundMusic');
                    if (bgMusic) {
                        bgMusic.pause();
                        bgMusic.currentTime = 0;
                    }
                } catch (e) {
                    console.error('Music stop error:', e);
                }
            }

            startGame() {
                this.state = 'playing';
                this.score = 0;
                this.updateDifficultyDisplay();
                this.startBackgroundMusic();
            }

            pauseGame() {
                if (this.state === 'playing') {
                    this.state = 'paused';
                }
            }

            resumeGame() {
                if (this.state === 'paused') {
                    this.state = 'playing';
                }
            }

            endGame(finalScore, drops, distance, jumps) {
                this.state = 'gameOver';
                this.stopBackgroundMusic();
                
                this.stats.gamesPlayed++;
                this.stats.totalDistance += distance;
                this.stats.totalDrops += drops;
                this.stats.totalJumps += jumps;
                this.stats.longestRun = Math.max(this.stats.longestRun, distance);

                if (finalScore > this.highScore) {
                    this.highScore = finalScore;
                }

                this.totalDrops += drops;
                this.saveGame();
                this.checkAchievements(finalScore, this.totalDrops);
            }

            checkAchievements(score, totalDrops) {
                const defs = [
                    { id: 'first', title: 'First Mission', desc: 'Complete your first run', check: this.stats.gamesPlayed >= 1 },
                    { id: 'drops100', title: 'Water Bearer', desc: 'Collect 100 water drops', check: totalDrops >= 100 },
                    { id: 'drops500', title: 'Aqua Guardian', desc: 'Collect 500 water drops', check: totalDrops >= 500 },
                    { id: 'score100', title: 'Survivor', desc: 'Score 100 in one run', check: score >= 100 },
                    { id: 'score500', title: 'Wasteland Warrior', desc: 'Score 500 in one run', check: score >= 500 },
                    { id: 'easy_master', title: 'Recruit Champion', desc: 'Score 500+ on RECRUIT', check: score >= 500 && this.difficulty === 'easy' },
                    { id: 'normal_master', title: 'Runner Elite', desc: 'Score 500+ on RUNNER', check: score >= 500 && this.difficulty === 'normal' },
                    { id: 'hard_master', title: 'Wasteland Legend', desc: 'Score 500+ on WASTELAND', check: score >= 500 && this.difficulty === 'hard' },
                    { id: 'games10', title: 'Persistent', desc: 'Attempt 10 missions', check: this.stats.gamesPlayed >= 10 },
                    { id: 'distance1000', title: 'Long Hauler', desc: 'Run 1000m total', check: this.stats.totalDistance >= 1000 }
                ];

                defs.forEach(def => {
                    if (def.check && !this.achievements.find(a => a.id === def.id)) {
                        const ach = { ...def, unlockedAt: Date.now() };
                        this.achievements.push(ach);
                        this.saveGame();
                        this.showAchievement(ach);
                        // Simple progression: unlock a skin at certain achievements
                        if (def.id === 'drops100') {
                            const skin = this.skins.find(s=>s.id==='sunset');
                            if (skin) skin.unlocked = true;
                        }
                        if (def.id === 'score500') {
                            const skin = this.skins.find(s=>s.id==='gold');
                            if (skin) skin.unlocked = true;
                        }
                    }
                });
            }

            showAchievement(ach) {
                const popup = document.getElementById('achievementPopup');
                document.getElementById('achievementTitle').textContent = ach.title;
                document.getElementById('achievementDesc').textContent = ach.desc;
                popup.classList.add('show');
                
                // Play achievement sound
                this.playAchievementSound();
                
                setTimeout(() => popup.classList.remove('show'), 4000);
            }

            playAchievementSound() {
                if (!this.soundEnabled) return;
                
                try {
                    const ctx = new (window.AudioContext || window.webkitAudioContext)();
                    
                    // Create a triumphant achievement sound
                    const notes = [
                        { freq: 523, time: 0 },      // C5
                        { freq: 659, time: 0.15 },   // E5
                        { freq: 784, time: 0.3 },    // G5
                        { freq: 1047, time: 0.45 }   // C6
                    ];
                    
                    notes.forEach(note => {
                        const osc = ctx.createOscillator();
                        const gain = ctx.createGain();
                        osc.connect(gain);
                        gain.connect(ctx.destination);
                        
                        osc.type = 'sine';
                        osc.frequency.value = note.freq;
                        gain.gain.value = 0;
                        
                        const startTime = ctx.currentTime + note.time;
                        const endTime = startTime + 0.3;
                        
                        gain.gain.setValueAtTime(0, startTime);
                        gain.gain.linearRampToValueAtTime(0.15, startTime + 0.02);
                        gain.gain.exponentialRampToValueAtTime(0.01, endTime);
                        
                        osc.start(startTime);
                        osc.stop(endTime);
                    });
                } catch (e) {}
            }
        }

        // ==================== Game Engine ====================
        class GameEngine {
            constructor(canvas, manager) {
                this.canvas = canvas;
                this.ctx = canvas.getContext('2d');
                this.manager = manager;
                this.frame = null;
                
                // State
                this.frameCount = 0;
                this.dropsCollected = 0;
                this.distance = 0;
                this.jumps = 0;
                this.combo = 0;
                this.comboTimer = 0;
                
                // Interactive features
                this.mouseX = 0;
                this.mouseY = 0;
                this.hoveredDrop = null;
                this.hoveredObstacle = null;
                this.hoveredPowerup = null;
                this.clickCooldown = 0;
                this.clickPower = 3; // Number of clicks available
                this.maxClickPower = 3;
                this.clickRechargeTimer = 0;
                this.clickEffects = [];
                this.manualCollects = 0;
                
                // Milestone tracking
                this.milestones = [
                    { score: 50, message: '💧 Every drop counts!', triggered: false },
                    { score: 100, message: '🌟 You\'re making a difference!', triggered: false },
                    { score: 200, message: '⚡ Unstoppable force!', triggered: false },
                    { score: 300, message: '🏆 Wasteland Champion!', triggered: false },
                    { score: 500, message: '💎 Legendary Runner!', triggered: false },
                    { score: 750, message: '🔥 Master of the Wasteland!', triggered: false },
                    { score: 1000, message: '👑 Water Protector Supreme!', triggered: false },
                    { score: 1500, message: '✨ Impossible is nothing!', triggered: false },
                    { score: 2000, message: '🌊 Hope for the future!', triggered: false }
                ];
                this.reachedMilestones = [];
                
                // Player
                this.player = {
                    x: 100, y: 0, w: 45, h: 55,
                    vy: 0, jumping: false,
                    shield: false, speedBoost: false, magnet: false, doublePoints: false
                };
                
                // Objects
                this.obstacles = [];
                this.drops = [];
                this.powerups = [];
                this.particles = [];
                this.wastelandDebris = [];
                
                // Timers
                this.powerupTimers = { shield: 0, speed: 0, magnet: 0, double: 0 };
                
                // Difficulty-based win/lose conditions
                const diff = this.getDifficultyMultipliers();
                this.winScore = diff.name === 'RECRUIT' ? 100 : diff.name === 'RUNNER' ? 200 : 300;
                this.timeLimit = diff.name === 'RECRUIT' ? 60 : diff.name === 'RUNNER' ? 45 : 30; // seconds
                this.startTime = null;

                this.resize();
                
                // Debounced resize for better performance
                let resizeTimeout;
                window.addEventListener('resize', () => {
                    clearTimeout(resizeTimeout);
                    resizeTimeout = setTimeout(() => this.resize(), 150);
                });
                
                // Immediate resize on orientation change
                window.addEventListener('orientationchange', () => {
                    setTimeout(() => this.resize(), 100);
                });
                
                this.setupInput();
                this.initDebris();
            }

            getDifficultyMultipliers() {
                return this.manager.getDifficultySettings();
            }

            resize() {
                const rect = this.canvas.getBoundingClientRect();
                const dpr = Math.min(window.devicePixelRatio || 1, 2); // Cap at 2 for performance
                this.canvas.width = rect.width * dpr;
                this.canvas.height = rect.height * dpr;
                this.ctx.scale(dpr, dpr);
                this.w = rect.width;
                this.h = rect.height;
                
                // Adjust ground level based on screen height for better mobile experience
                const groundOffset = this.h < 400 ? 60 : 90;
                this.ground = rect.height - groundOffset;
                this.player.y = this.ground - this.player.h;
            }

            initDebris() {
                for (let i = 0; i < 15; i++) {
                    this.wastelandDebris.push({
                        x: Math.random() * this.w,
                        y: this.ground - Math.random() * 50,
                        size: 5 + Math.random() * 10,
                        speed: 0.5 + Math.random() * 1.5,
                        opacity: 0.1 + Math.random() * 0.2
                    });
                }
            }

            setupInput() {
                const jump = () => {
                    if (this.manager.state === 'playing' && !this.player.jumping) {
                        this.jump();
                    }
                };

                // Mouse tracking
                this.canvas.addEventListener('mousemove', (e) => {
                    const rect = this.canvas.getBoundingClientRect();
                    const scaleX = this.w / rect.width;
                    const scaleY = this.h / rect.height;
                    this.mouseX = (e.clientX - rect.left) * scaleX;
                    this.mouseY = (e.clientY - rect.top) * scaleY;
                    this.updateHoveredObjects();
                });

                // Click interactions
                this.canvas.addEventListener('click', (e) => {
                    const rect = this.canvas.getBoundingClientRect();
                    const scaleX = this.w / rect.width;
                    const scaleY = this.h / rect.height;
                    const clickX = (e.clientX - rect.left) * scaleX;
                    const clickY = (e.clientY - rect.top) * scaleY;
                    
                    if (this.manager.state === 'playing') {
                        this.handleCanvasClick(clickX, clickY);
                    } else {
                        jump();
                    }
                });

                // Touch interactions with better scaling
                this.canvas.addEventListener('touchstart', (e) => {
                    e.preventDefault();
                    if (e.touches.length > 0) {
                        const rect = this.canvas.getBoundingClientRect();
                        const scaleX = this.w / rect.width;
                        const scaleY = this.h / rect.height;
                        const touchX = (e.touches[0].clientX - rect.left) * scaleX;
                        const touchY = (e.touches[0].clientY - rect.top) * scaleY;
                        
                        if (this.manager.state === 'playing') {
                            this.handleCanvasClick(touchX, touchY);
                        } else {
                            jump();
                        }
                    }
                }, { passive: false });

                // Touch move for hover effects on mobile
                this.canvas.addEventListener('touchmove', (e) => {
                    if (e.touches.length > 0) {
                        const rect = this.canvas.getBoundingClientRect();
                        const scaleX = this.w / rect.width;
                        const scaleY = this.h / rect.height;
                        this.mouseX = (e.touches[0].clientX - rect.left) * scaleX;
                        this.mouseY = (e.touches[0].clientY - rect.top) * scaleY;
                        this.updateHoveredObjects();
                    }
                }, { passive: true });

                window.addEventListener('keydown', (e) => {
                    if (e.code === 'Space' || e.code === 'ArrowUp') {
                        e.preventDefault();
                        jump();
                    } else if (e.code === 'Escape') {
                        if (this.manager.state === 'playing') {
                            this.manager.pauseGame();
                            ui.showPause();
                        } else if (this.manager.state === 'paused') {
                            this.manager.resumeGame();
                            ui.hidePause();
                            this.loop();
                        }
                    }
                });

                // Change cursor based on hover
                this.canvas.addEventListener('mousemove', () => {
                    if (this.manager.state === 'playing') {
                        if (this.hoveredDrop || this.hoveredObstacle || this.hoveredPowerup) {
                            this.canvas.style.cursor = 'pointer';
                        } else {
                            this.canvas.style.cursor = 'default';
                        }
                    }
                });
            }

            handleCanvasClick(x, y) {
                let actionTaken = false;

                // Check if clicked on a drop
                for (let i = this.drops.length - 1; i >= 0; i--) {
                    const drop = this.drops[i];
                    if (this.pointInRect(x, y, drop)) {
                        this.collectDropByClick(drop, i);
                        actionTaken = true;
                        break;
                    }
                }

                // Check if clicked on a powerup
                if (!actionTaken) {
                    for (let i = this.powerups.length - 1; i >= 0; i--) {
                        const p = this.powerups[i];
                        if (this.pointInRect(x, y, p)) {
                            this.activatePowerupByClick(p, i);
                            actionTaken = true;
                            break;
                        }
                    }
                }

                // Check if clicked on an obstacle (with click power)
                if (!actionTaken && this.clickPower > 0) {
                    for (let i = this.obstacles.length - 1; i >= 0; i--) {
                        const obs = this.obstacles[i];
                        if (this.pointInRect(x, y, obs)) {
                            this.destroyObstacleByClick(obs, i);
                            actionTaken = true;
                            break;
                        }
                    }
                }

                // Click effect regardless
                this.addClickEffect(x, y, actionTaken);
            }

            updateHoveredObjects() {
                this.hoveredDrop = null;
                this.hoveredObstacle = null;
                this.hoveredPowerup = null;

                // Check drops
                for (const drop of this.drops) {
                    if (this.pointInRect(this.mouseX, this.mouseY, drop)) {
                        this.hoveredDrop = drop;
                        break;
                    }
                }

                // Check obstacles
                if (!this.hoveredDrop) {
                    for (const obs of this.obstacles) {
                        if (this.pointInRect(this.mouseX, this.mouseY, obs)) {
                            this.hoveredObstacle = obs;
                            break;
                        }
                    }
                }

                // Check powerups
                if (!this.hoveredDrop && !this.hoveredObstacle) {
                    for (const p of this.powerups) {
                        if (this.pointInRect(this.mouseX, this.mouseY, p)) {
                            this.hoveredPowerup = p;
                            break;
                        }
                    }
                }
            }

            pointInRect(x, y, rect) {
                return x >= rect.x && x <= rect.x + rect.w && y >= rect.y && y <= rect.y + rect.h;
            }

            collectDropByClick(drop, index) {
                this.dropsCollected++;
                this.manualCollects++;
                const bonus = 25 * (this.combo + 1);
                this.manager.score += bonus;
                this.combo++;
                this.comboTimer = 150;
                
                this.explode(drop.x + drop.w / 2, drop.y + drop.h / 2, 30, '#00d9ff');
                this.showFloatingText(drop.x + drop.w / 2, drop.y, `+${bonus} 💧 CLICK!`, '#00d9ff');
                
                // Play combo sound for manual clicks with combos
                if (this.combo >= 3) {
                    this.sound('combo');
                } else {
                    this.sound('drop');
                }
                this.drops.splice(index, 1);
            }

            activatePowerupByClick(powerup, index) {
                const diff = this.getDifficultyMultipliers();
                const baseDuration = {
                    shield: 350,
                    speed: 300,
                    magnet: 350
                };
                
                if (powerup.type === 'shield') {
                    this.player.shield = true;
                    this.powerupTimers.shield = baseDuration.shield * diff.powerupDuration;
                    this.explode(powerup.x + powerup.w / 2, powerup.y + powerup.h / 2, 35, '#00d9ff');
                    this.showFloatingText(powerup.x + powerup.w / 2, powerup.y, '🛡️ SHIELD!', '#00d9ff');
                } else if (powerup.type === 'speed') {
                    this.player.speedBoost = true;
                    this.powerupTimers.speed = baseDuration.speed * diff.powerupDuration;
                    this.explode(powerup.x + powerup.w / 2, powerup.y + powerup.h / 2, 35, '#ff9800');
                    this.showFloatingText(powerup.x + powerup.w / 2, powerup.y, '⚡ BOOST!', '#ff9800');
                } else if (powerup.type === 'magnet') {
                    this.player.magnet = true;
                    this.powerupTimers.magnet = baseDuration.magnet * diff.powerupDuration;
                    this.explode(powerup.x + powerup.w / 2, powerup.y + powerup.h / 2, 35, '#00d9ff');
                    this.showFloatingText(powerup.x + powerup.w / 2, powerup.y, '🧲 MAGNET!', '#00d9ff');
                }
                playSound('powerupSound');
                this.powerups.splice(index, 1);
            }

            destroyObstacleByClick(obstacle, index) {
                this.clickPower--;
                this.manager.score += 50;
                this.explode(obstacle.x + obstacle.w / 2, obstacle.y + obstacle.h / 2, 40, '#ff9800');
                this.showFloatingText(obstacle.x + obstacle.w / 2, obstacle.y, '+50 💥 DESTROYED!', '#ff9800');
                this.sound('destroy');
                this.obstacles.splice(index, 1);
                
                // Start recharge timer
                if (this.clickPower === 0) {
                    this.clickRechargeTimer = 300; // 5 seconds at 60fps
                }
            }

            addClickEffect(x, y, success) {
                this.clickEffects.push({
                    x, y,
                    radius: 10,
                    maxRadius: success ? 50 : 30,
                    alpha: 1,
                    color: success ? '#00d9ff' : '#ffffff'
                });

                // Play click sound
                this.sound('click');

                // Small particle burst
                for (let i = 0; i < 8; i++) {
                    this.particles.push({
                        x, y,
                        vx: (Math.random() - 0.5) * 8,
                        vy: (Math.random() - 0.5) * 8,
                        life: 30,
                        maxLife: 30,
                        color: success ? '#00d9ff' : '#ffffff',
                        size: Math.random() * 3 + 2
                    });
                }
            }

            showFloatingText(x, y, text, color) {
                this.particles.push({
                    x, y: y - 10,
                    vx: 0,
                    vy: -2,
                    life: 60,
                    maxLife: 60,
                    text,
                    color,
                    size: 1,
                    isText: true
                });
            }

            jump() {
                const diff = this.getDifficultyMultipliers();
                this.player.vy = diff.jumpForce;
                this.player.jumping = true;
                this.jumps++;
                
                // Cyan particles
                for (let i = 0; i < 12; i++) {
                    this.particles.push({
                        x: this.player.x + this.player.w / 2,
                        y: this.player.y + this.player.h,
                        vx: (Math.random() - 0.5) * 5,
                        vy: Math.random() * 3,
                        life: 35,
                        maxLife: 35,
                        color: '#00d9ff',
                        size: Math.random() * 4 + 2
                    });
                }
                
                this.sound('jump');
            }

            checkMilestones() {
                const currentScore = Math.floor(this.manager.score);
                
                for (let i = 0; i < this.milestones.length; i++) {
                    const milestone = this.milestones[i];
                    
                    // Check if we've reached this milestone and haven't triggered it yet
                    if (currentScore >= milestone.score && !milestone.triggered) {
                        milestone.triggered = true;
                        this.reachedMilestones.push(milestone);
                        this.showMilestoneMessage(milestone);
                    }
                }
            }

            showMilestoneMessage(milestone) {
                // Create large centered floating text
                const centerX = this.w / 2;
                const centerY = this.h / 3;
                
                // Add the milestone message as a special particle
                this.particles.push({
                    x: centerX,
                    y: centerY,
                    vx: 0,
                    vy: -0.5,
                    life: 120,
                    maxLife: 120,
                    text: milestone.message,
                    color: '#FFD700',
                    size: 2.5,
                    isText: true,
                    isMilestone: true
                });
                
                // Create celebration particles
                for (let i = 0; i < 40; i++) {
                    const angle = (Math.PI * 2 * i) / 40;
                    this.particles.push({
                        x: centerX,
                        y: centerY,
                        vx: Math.cos(angle) * (3 + Math.random() * 3),
                        vy: Math.sin(angle) * (3 + Math.random() * 3),
                        life: 60,
                        maxLife: 60,
                        color: i % 2 === 0 ? '#FFD700' : '#00d9ff',
                        size: Math.random() * 4 + 3
                    });
                }
                
                // Play milestone celebration sound
                this.sound('milestone');
            }

            sound(type) {
                if (!this.manager.soundEnabled) return;
                
                try {
                    const ctx = new (window.AudioContext || window.webkitAudioContext)();
                    const osc = ctx.createOscillator();
                    const gain = ctx.createGain();
                    const osc2 = ctx.createOscillator();
                    const gain2 = ctx.createGain();
                    
                    osc.connect(gain);
                    gain.connect(ctx.destination);
                    
                    if (type === 'jump') {
                        // Quick pop sound
                        osc.frequency.value = 450;
                        gain.gain.value = 0.08;
                        osc.start();
                        gain.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 0.12);
                        osc.stop(ctx.currentTime + 0.12);
                    } else if (type === 'drop') {
                        // Pleasant water drop collection sound
                        osc.type = 'sine';
                        osc.frequency.value = 880;
                        gain.gain.value = 0.12;
                        osc.start();
                        osc.frequency.exponentialRampToValueAtTime(1320, ctx.currentTime + 0.05);
                        gain.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 0.08);
                        osc.stop(ctx.currentTime + 0.08);
                    } else if (type === 'powerup') {
                        // Play powerup sound from audio file
                        playSound('powerupSound');
                        return;
                    } else if (type === 'hit') {
                        // Play hit sound from audio file when player is hit
                        playSound('hitSound');
                        return;
                    } else if (type === 'miss') {
                        // Sound effect removed for miss
                        return;
                    } else if (type === 'combo') {
                        // Special combo sound
                        osc.type = 'sine';
                        osc2.type = 'sine';
                        osc2.connect(gain2);
                        gain2.connect(ctx.destination);
                        
                        osc.frequency.value = 880;
                        osc2.frequency.value = 1320;
                        gain.gain.value = 0.08;
                        gain2.gain.value = 0.08;
                        
                        osc.start();
                        osc2.start(ctx.currentTime + 0.05);
                        
                        gain.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 0.15);
                        gain2.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 0.2);
                        
                        osc.stop(ctx.currentTime + 0.15);
                        osc2.stop(ctx.currentTime + 0.2);
                    } else if (type === 'win') {
                        // Victory fanfare
                        osc.type = 'sine';
                        osc2.type = 'sine';
                        const osc3 = ctx.createOscillator();
                        const gain3 = ctx.createGain();
                        osc3.type = 'sine';
                        
                        osc2.connect(gain2);
                        gain2.connect(ctx.destination);
                        osc3.connect(gain3);
                        gain3.connect(ctx.destination);
                        
                        // Three note victory chord
                        osc.frequency.value = 523;  // C5
                        osc2.frequency.value = 659; // E5
                        osc3.frequency.value = 784; // G5
                        
                        gain.gain.value = 0.1;
                        gain2.gain.value = 0.1;
                        gain3.gain.value = 0.1;
                        
                        osc.start();
                        osc2.start();
                        osc3.start();
                        
                        gain.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 0.5);
                        gain2.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 0.5);
                        gain3.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 0.5);
                        
                        osc.stop(ctx.currentTime + 0.5);
                        osc2.stop(ctx.currentTime + 0.5);
                        osc3.stop(ctx.currentTime + 0.5);
                    } else if (type === 'click') {
                        // Click feedback sound
                        osc.type = 'sine';
                        osc.frequency.value = 1200;
                        gain.gain.value = 0.05;
                        osc.start();
                        gain.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 0.05);
                        osc.stop(ctx.currentTime + 0.05);
                    } else if (type === 'destroy') {
                        // Obstacle destroy sound
                        osc.type = 'sawtooth';
                        osc.frequency.value = 400;
                        gain.gain.value = 0.1;
                        osc.start();
                        osc.frequency.exponentialRampToValueAtTime(100, ctx.currentTime + 0.2);
                        gain.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 0.2);
                        osc.stop(ctx.currentTime + 0.2);
                    } else if (type === 'milestone') {
                        // Milestone celebration sound - more elaborate than regular win
                        osc.type = 'sine';
                        osc2.type = 'sine';
                        const osc3 = ctx.createOscillator();
                        const gain3 = ctx.createGain();
                        const osc4 = ctx.createOscillator();
                        const gain4 = ctx.createGain();
                        osc3.type = 'sine';
                        osc4.type = 'sine';
                        
                        osc2.connect(gain2);
                        gain2.connect(ctx.destination);
                        osc3.connect(gain3);
                        gain3.connect(ctx.destination);
                        osc4.connect(gain4);
                        gain4.connect(ctx.destination);
                        
                        // Four note ascending celebration
                        osc.frequency.value = 523;   // C5
                        osc2.frequency.value = 659;  // E5
                        osc3.frequency.value = 784;  // G5
                        osc4.frequency.value = 1047; // C6
                        
                        gain.gain.value = 0.1;
                        gain2.gain.value = 0.1;
                        gain3.gain.value = 0.1;
                        gain4.gain.value = 0.1;
                        
                        osc.start();
                        osc2.start(ctx.currentTime + 0.1);
                        osc3.start(ctx.currentTime + 0.2);
                        osc4.start(ctx.currentTime + 0.3);
                        
                        gain.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 0.4);
                        gain2.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 0.5);
                        gain3.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 0.6);
                        gain4.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 0.7);
                        
                        osc.stop(ctx.currentTime + 0.4);
                        osc2.stop(ctx.currentTime + 0.5);
                        osc3.stop(ctx.currentTime + 0.6);
                        osc4.stop(ctx.currentTime + 0.7);
                    }
                } catch (e) {}
            }

            start() {
                const diff = this.getDifficultyMultipliers();
                
                this.frameCount = 0;
                this.BASE_SPEED = 6.5 * diff.speedMultiplier;
                this.speed = this.BASE_SPEED;
                this.GRAVITY = diff.gravity;
                this.dropsCollected = 0;
                this.distance = 0;
                this.jumps = 0;
                this.combo = 0;
                this.comboTimer = 0;
                this.manualCollects = 0;
                this.clickPower = this.maxClickPower;
                this.clickRechargeTimer = 0;
                this.clickEffects = [];
                
                this.player.y = this.ground - this.player.h;
                this.player.vy = 0;
                this.player.jumping = false;
                this.player.shield = false;
                this.player.speedBoost = false;
                this.player.magnet = false;
                
                this.obstacles = [];
                this.drops = [];
                this.powerups = [];
                this.particles = [];
                this.powerupTimers = { shield: 0, speed: 0, magnet: 0 };
                
                // Reset milestone tracking
                this.reachedMilestones = [];
                this.milestones.forEach(m => m.triggered = false);
                
                this.loop();
            }

            loop() {
                if (this.manager.state !== 'playing') return;

                if (!this.startTime) this.startTime = Date.now();
                this.frameCount++;
                this.update();
                this.render();

                // Difficulty-based win/lose conditions
                const elapsed = (Date.now() - this.startTime) / 1000;
                if (this.manager.score >= this.winScore) {
                    playSound('missionCompleteSound');
                    this.manager.endGame(Math.floor(this.manager.score), this.dropsCollected, this.distance, this.jumps);
                    return;
                }
                if (elapsed >= this.timeLimit) {
                    this.manager.endGame(Math.floor(this.manager.score), this.dropsCollected, this.distance, this.jumps);
                    return;
                }

                this.frame = requestAnimationFrame(() => this.loop());
            }

            update() {
                const diff = this.getDifficultyMultipliers();
                
                // Debris
                this.wastelandDebris.forEach(d => {
                    d.x -= d.speed;
                    if (d.x + d.size < 0) {
                        d.x = this.w;
                        d.y = this.ground - Math.random() * 50;
                    }
                });
                
                // Player physics
                this.player.vy += this.GRAVITY;
                this.player.y += this.player.vy;
                
                if (this.player.y >= this.ground - this.player.h) {
                    this.player.y = this.ground - this.player.h;
                    this.player.vy = 0;
                    this.player.jumping = false;
                }
                
                // Speed with difficulty multiplier
                this.speed = this.BASE_SPEED + Math.floor(this.distance / 500) * 0.6;
                if (this.player.speedBoost) this.speed *= 1.6;
                
                // Score
                this.manager.score += this.speed * 0.12;
                this.distance += this.speed * 0.12;
                
                // Check milestones
                this.checkMilestones();
                
                // Powerup timers with difficulty duration
                Object.keys(this.powerupTimers).forEach(k => {
                    if (this.powerupTimers[k] > 0) this.powerupTimers[k]--;
                });
                if (this.powerupTimers.shield <= 0) this.player.shield = false;
                if (this.powerupTimers.speed <= 0) this.player.speedBoost = false;
                if (this.powerupTimers.magnet <= 0) this.player.magnetActive = false;
                
                // Combo
                if (this.comboTimer > 0) this.comboTimer--;
                if (this.comboTimer === 0) this.combo = 0;
                
                // Click power recharge
                if (this.clickRechargeTimer > 0) {
                    this.clickRechargeTimer--;
                    if (this.clickRechargeTimer === 0) {
                        this.clickPower = this.maxClickPower;
                    }
                }
                
                // Particles
                for (let i = this.particles.length - 1; i >= 0; i--) {
                    const p = this.particles[i];
                    if (!p.isText) {
                        p.x += p.vx;
                        p.y += p.vy;
                        p.vy += 0.25;
                    } else {
                        p.y += p.vy;
                    }
                    p.life--;
                    if (p.life <= 0) this.particles.splice(i, 1);
                }
                
                // Click effects
                for (let i = this.clickEffects.length - 1; i >= 0; i--) {
                    const e = this.clickEffects[i];
                    e.radius += 4;
                    e.alpha -= 0.05;
                    if (e.alpha <= 0) this.clickEffects.splice(i, 1);
                }
                
                // Obstacles
                for (let i = this.obstacles.length - 1; i >= 0; i--) {
                    const obs = this.obstacles[i];
                    obs.x -= this.speed;
                    if (obs.x + obs.w < 0) {
                        this.obstacles.splice(i, 1);
                        continue;
                    }
                    if (this.collide(this.player, obs)) {
                        if (this.player.shield) {
                            this.player.shield = false;
                            this.powerupTimers.shield = 0;
                            this.obstacles.splice(i, 1);
                            this.explode(this.player.x + this.player.w / 2, this.player.y + this.player.h / 2, 25, '#00d9ff');
                            this.sound('destroy');
                        } else {
                            this.manager.endGame(Math.floor(this.manager.score), this.dropsCollected, this.distance, this.jumps);
                            playSound('missionCompleteSound');
                            return;
                        }
                    }
                }
                
                // Drops
                for (let i = this.drops.length - 1; i >= 0; i--) {
                    const drop = this.drops[i];
                    
                    // Magnet
                    if (this.player.magnet) {
                        const dx = (this.player.x + this.player.w / 2) - drop.x;
                        const dy = (this.player.y + this.player.h / 2) - drop.y;
                        const dist = Math.sqrt(dx * dx + dy * dy);
                        if (dist < 250) {
                            drop.x += dx * 0.12;
                            drop.y += dy * 0.12;
                        }
                    }
                    
                    drop.x -= this.speed;
                    if (drop.x + drop.w < 0) {
                        this.sound('miss');
                        this.drops.splice(i, 1);
                        continue;
                    }
                    if (this.collide(this.player, drop)) {
                        this.dropsCollected++;
                        this.manager.score += 10 * (this.combo + 1);
                        this.combo++;
                        this.comboTimer = 150;
                        this.explode(drop.x + drop.w / 2, drop.y + drop.h / 2, 18, '#00d9ff');
                        
                        // Play combo sound for combos >= 3, otherwise regular drop sound
                        if (this.combo >= 3) {
                            this.sound('combo');
                        } else {
                            this.sound('drop');
                        }
                        this.drops.splice(i, 1);
                    }
                }
                
                // Powerups
                for (let i = this.powerups.length - 1; i >= 0; i--) {
                    const p = this.powerups[i];
                    p.x -= this.speed;
                    if (p.x + p.w < 0) {
                        this.powerups.splice(i, 1);
                        continue;
                    }
                    if (this.collide(this.player, p)) {
                        const baseDuration = {
                            shield: 350,
                            speed: 300,
                            magnet: 350
                        };
                        
                        if (p.type === 'shield') {
                            this.player.shield = true;
                            this.powerupTimers.shield = baseDuration.shield * diff.powerupDuration;
                            this.explode(p.x + p.w / 2, p.y + p.h / 2, 25, '#00d9ff');
                        } else if (p.type === 'speed') {
                            this.player.speedBoost = true;
                            this.powerupTimers.speed = baseDuration.speed * diff.powerupDuration;
                            this.explode(p.x + p.w / 2, p.y + p.h / 2, 25, '#ff9800');
                        } else if (p.type === 'magnet') {
                            this.player.magnet = true;
                            this.powerupTimers.magnet = baseDuration.magnet * diff.powerupDuration;
                            this.explode(p.x + p.w / 2, p.y + p.h / 2, 25, '#00d9ff');
                        }
                        this.sound('powerup');
                        this.powerups.splice(i, 1);
                    }
                }
                
                // Spawn with difficulty rates
                const obsInt = Math.max(60, (110 - Math.floor(this.distance / 1000) * 10) * diff.obstacleSpawnRate);
                const dropInt = Math.max(50, (90 - Math.floor(this.distance / 800) * 8) * diff.dropSpawnRate);
                
                if (this.frameCount % Math.floor(obsInt) === 0) this.spawnObstacle();
                if (this.frameCount % Math.floor(dropInt) === 0) this.spawnDrop();
                if (this.frameCount % 450 === 0) this.spawnPowerup();
            }

            render() {
                // Clear
                this.ctx.clearRect(0, 0, this.w, this.h);
                
                // Wasteland Sky
                const skyGrad = this.ctx.createLinearGradient(0, 0, 0, this.h);
                skyGrad.addColorStop(0, '#0a1f2e');
                skyGrad.addColorStop(0.5, '#163447');
                skyGrad.addColorStop(1, '#1a4d5c');
                this.ctx.fillStyle = skyGrad;
                this.ctx.fillRect(0, 0, this.w, this.h);
                
                // Wasteland Ground
                const groundGrad = this.ctx.createLinearGradient(0, this.ground, 0, this.h);
                groundGrad.addColorStop(0, '#d4a574');
                groundGrad.addColorStop(0.5, '#b8895a');
                groundGrad.addColorStop(1, '#8f6a45');
                this.ctx.fillStyle = groundGrad;
                this.ctx.fillRect(0, this.ground, this.w, this.h - this.ground);
                
                // Ground cracks
                this.ctx.strokeStyle = 'rgba(0, 0, 0, 0.3)';
                this.ctx.lineWidth = 2;
                for (let i = 0; i < this.w; i += 80) {
                    this.ctx.beginPath();
                    this.ctx.moveTo(i - (this.frameCount % 80), this.ground + 10);
                    this.ctx.lineTo(i + 40 - (this.frameCount % 80), this.ground + 30);
                    this.ctx.stroke();
                }
                
                // Debris
                this.wastelandDebris.forEach(d => {
                    this.ctx.fillStyle = `rgba(100, 100, 100, ${d.opacity})`;
                    this.ctx.beginPath();
                    this.ctx.arc(d.x, d.y, d.size, 0, Math.PI * 2);
                    this.ctx.fill();
                });
                
                // Click effects
                this.clickEffects.forEach(e => {
                    this.ctx.strokeStyle = e.color + Math.floor(e.alpha * 255).toString(16).padStart(2, '0');
                    this.ctx.lineWidth = 3;
                    this.ctx.beginPath();
                    this.ctx.arc(e.x, e.y, e.radius, 0, Math.PI * 2);
                    this.ctx.stroke();
                });
                
                // Particles
                this.particles.forEach(p => {
                    const alpha = p.life / p.maxLife;
                    
                    if (p.isText) {
                        this.ctx.save();
                        this.ctx.globalAlpha = alpha;
                        this.ctx.fillStyle = p.color;
                        
                        // Milestone messages are larger and more prominent
                        if (p.isMilestone) {
                            const fontSize = 32 * p.size;
                            this.ctx.font = `bold ${fontSize}px "Source Sans Pro", "Open Sans", sans-serif`;
                            this.ctx.shadowColor = p.color;
                            this.ctx.shadowBlur = 25;
                            this.ctx.textAlign = 'center';
                            
                            // Add outline for better visibility
                            this.ctx.strokeStyle = '#000000';
                            this.ctx.lineWidth = 3;
                            this.ctx.strokeText(p.text, p.x, p.y);
                            this.ctx.fillText(p.text, p.x, p.y);
                        } else {
                            // Regular floating text
                            this.ctx.font = 'bold 18px "Source Sans Pro", "Open Sans", sans-serif';
                            this.ctx.shadowColor = p.color;
                            this.ctx.shadowBlur = 10;
                            this.ctx.textAlign = 'center';
                            this.ctx.fillText(p.text, p.x, p.y);
                        }
                        
                        this.ctx.shadowBlur = 0;
                        this.ctx.restore();
                    } else {
                        this.ctx.fillStyle = p.color + Math.floor(alpha * 255).toString(16).padStart(2, '0');
                        this.ctx.beginPath();
                        this.ctx.arc(p.x, p.y, p.size * alpha, 0, Math.PI * 2);
                        this.ctx.fill();
                    }
                });
                
                // Draw game objects
                this.obstacles.forEach(obs => this.drawObstacle(obs, obs === this.hoveredObstacle));
                this.drops.forEach(drop => this.drawDrop(drop, drop === this.hoveredDrop));
                this.powerups.forEach(p => this.drawPowerup(p, p === this.hoveredPowerup));
                this.drawPlayer();
                this.drawUI();
            }

            drawPlayer() {
                this.ctx.save();
                
                // Effects
                if (this.player.shield) {
                    const pulse = Math.sin(this.frameCount * 0.15) * 3;
                    this.ctx.strokeStyle = '#00d9ff';
                    this.ctx.lineWidth = 4;
                    this.ctx.globalAlpha = 0.6;
                    this.ctx.beginPath();
                    this.ctx.arc(this.player.x + this.player.w / 2, this.player.y + this.player.h / 2, this.player.w / 2 + 12 + pulse, 0, Math.PI * 2);
                    this.ctx.stroke();
                    this.ctx.globalAlpha = 1;
                }
                
                if (this.player.speedBoost) {
                    this.ctx.strokeStyle = '#ff9800';
                    this.ctx.lineWidth = 3;
                    this.ctx.globalAlpha = 0.6;
                    for (let i = 0; i < 4; i++) {
                        this.ctx.beginPath();
                        this.ctx.moveTo(this.player.x - 25 - i * 15, this.player.y + Math.random() * this.player.h);
                        this.ctx.lineTo(this.player.x - 15 - i * 15, this.player.y + Math.random() * this.player.h);
                        this.ctx.stroke();
                    }
                    this.ctx.globalAlpha = 1;
                }
                
                if (this.player.magnet) {
                    const pulse = Math.sin(this.frameCount * 0.2) * 100;
                    this.ctx.strokeStyle = '#00d9ff';
                    this.ctx.lineWidth = 2;
                    this.ctx.globalAlpha = 0.2;
                    this.ctx.beginPath();
                    this.ctx.arc(this.player.x + this.player.w / 2, this.player.y + this.player.h / 2, 150 + pulse, 0, Math.PI * 2);
                    this.ctx.stroke();
                    this.ctx.globalAlpha = 1;
                }
                
                // Runner body
                // Use selected skin colors if available
                let skinColors = ['#00d9ff','#0097a7','#006064'];
                try {
                    const s = this.manager.skins.find(k => k.id === this.manager.selectedSkin);
                    if (s) skinColors = s.color;
                } catch (e) {}
                const grad = this.ctx.createLinearGradient(this.player.x, this.player.y, this.player.x, this.player.y + this.player.h);
                grad.addColorStop(0, skinColors[0]);
                grad.addColorStop(0.5, skinColors[1]);
                grad.addColorStop(1, skinColors[2]);
                this.ctx.fillStyle = grad;
                
                // Helmet
                this.ctx.beginPath();
                this.ctx.arc(this.player.x + this.player.w / 2, this.player.y + 12, 12, 0, Math.PI * 2);
                this.ctx.fill();
                
                // Body
                this.ctx.fillRect(this.player.x + 10, this.player.y + 20, this.player.w - 20, 25);
                
                // Arms
                this.ctx.fillRect(this.player.x + 5, this.player.y + 25, 8, 15);
                this.ctx.fillRect(this.player.x + this.player.w - 13, this.player.y + 25, 8, 15);
                
                // Legs
                const legOffset = Math.sin(this.frameCount * 0.3) * 3;
                this.ctx.fillRect(this.player.x + 12, this.player.y + 40, 8, 15 + legOffset);
                this.ctx.fillRect(this.player.x + this.player.w - 20, this.player.y + 40, 8, 15 - legOffset);
                
                // Visor
                this.ctx.fillStyle = '#00d9ff';
                this.ctx.globalAlpha = 0.8;
                this.ctx.fillRect(this.player.x + this.player.w / 2 - 8, this.player.y + 10, 16, 4);
                this.ctx.globalAlpha = 1;
                
                this.ctx.restore();
            }

            drawObstacle(obs, isHovered) {
                this.ctx.save();
                
                // Hover effect
                if (isHovered && this.clickPower > 0) {
                    this.ctx.shadowColor = '#ff9800';
                    this.ctx.shadowBlur = 20;
                    const pulse = Math.sin(this.frameCount * 0.2) * 3;
                    this.ctx.translate(0, pulse);
                    
                    // Draw target crosshair
                    this.ctx.strokeStyle = '#ff9800';
                    this.ctx.lineWidth = 2;
                    this.ctx.globalAlpha = 0.8;
                    const cx = obs.x + obs.w / 2;
                    const cy = obs.y + obs.h / 2;
                    this.ctx.beginPath();
                    this.ctx.moveTo(cx - 20, cy);
                    this.ctx.lineTo(cx + 20, cy);
                    this.ctx.moveTo(cx, cy - 20);
                    this.ctx.lineTo(cx, cy + 20);
                    this.ctx.stroke();
                    this.ctx.beginPath();
                    this.ctx.arc(cx, cy, 15, 0, Math.PI * 2);
                    this.ctx.stroke();
                    this.ctx.globalAlpha = 1;
                }
                
                const grad = this.ctx.createLinearGradient(obs.x, obs.y, obs.x + obs.w, obs.y + obs.h);
                grad.addColorStop(0, isHovered ? '#7a5a4a' : '#5a4a3a');
                grad.addColorStop(1, isHovered ? '#5a3a2a' : '#3a2a1a');
                this.ctx.fillStyle = grad;
                
                this.ctx.beginPath();
                this.ctx.moveTo(obs.x + obs.w / 2, obs.y);
                this.ctx.lineTo(obs.x + obs.w, obs.y + obs.h * 0.7);
                this.ctx.lineTo(obs.x + obs.w * 0.8, obs.y + obs.h);
                this.ctx.lineTo(obs.x + obs.w * 0.2, obs.y + obs.h);
                this.ctx.lineTo(obs.x, obs.y + obs.h * 0.7);
                this.ctx.closePath();
                this.ctx.fill();
                
                this.ctx.strokeStyle = isHovered ? '#ff9800' : '#8f6a45';
                this.ctx.lineWidth = isHovered ? 3 : 2;
                this.ctx.stroke();
                
                this.ctx.shadowBlur = 0;
                this.ctx.restore();
            }

            drawDrop(drop, isHovered) {
                const rot = this.frameCount * 0.12;
                const bounce = Math.sin(this.frameCount * 0.15 + drop.x * 0.01) * 3;
                const scale = isHovered ? 1.2 : 1;
                const pulse = isHovered ? Math.sin(this.frameCount * 0.3) * 0.1 + 1 : 1;
                
                this.ctx.save();
                this.ctx.translate(drop.x + drop.w / 2, drop.y + drop.h / 2 + bounce);
                this.ctx.rotate(rot);
                this.ctx.scale(scale * pulse, scale * pulse);
                
                const dropGrad = this.ctx.createRadialGradient(0, -3, 0, 0, 0, drop.w / 2);
                dropGrad.addColorStop(0, '#00d9ff');
                dropGrad.addColorStop(0.7, '#00b8d4');
                dropGrad.addColorStop(1, '#0097a7');
                this.ctx.fillStyle = dropGrad;
                
                this.ctx.beginPath();
                this.ctx.moveTo(0, -drop.h / 2);
                this.ctx.quadraticCurveTo(drop.w / 2, 0, drop.w / 2, drop.h / 3);
                this.ctx.quadraticCurveTo(drop.w / 2, drop.h / 2, 0, drop.h / 2);
                this.ctx.quadraticCurveTo(-drop.w / 2, drop.h / 2, -drop.w / 2, drop.h / 3);
                this.ctx.quadraticCurveTo(-drop.w / 2, 0, 0, -drop.h / 2);
                this.ctx.fill();
                
                this.ctx.shadowColor = '#00d9ff';
                this.ctx.shadowBlur = isHovered ? 25 : 15;
                this.ctx.fill();
                this.ctx.shadowBlur = 0;
                
                // Hover indicator
                if (isHovered) {
                    this.ctx.strokeStyle = '#ffffff';
                    this.ctx.lineWidth = 2;
                    this.ctx.globalAlpha = 0.6;
                    this.ctx.beginPath();
                    this.ctx.arc(0, 0, drop.w / 2 + 8, 0, Math.PI * 2);
                    this.ctx.stroke();
                    this.ctx.globalAlpha = 1;
                }
                
                this.ctx.restore();
            }

            drawPowerup(p, isHovered) {
                const bounce = Math.sin(this.frameCount * 0.12 + p.x * 0.01) * 8;
                const pulse = 1 + Math.sin(this.frameCount * 0.15) * 0.1;
                const hoverScale = isHovered ? 1.3 : 1;
                
                this.ctx.save();
                this.ctx.translate(p.x + p.w / 2, p.y + p.h / 2 + bounce);
                this.ctx.scale(pulse * hoverScale, pulse * hoverScale);
                
                if (p.type === 'shield') {
                    this.ctx.strokeStyle = '#00d9ff';
                    this.ctx.lineWidth = isHovered ? 4 : 3;
                    this.ctx.shadowColor = '#00d9ff';
                    this.ctx.shadowBlur = isHovered ? 25 : 15;
                    this.ctx.beginPath();
                    this.ctx.arc(0, 0, p.w / 2, 0, Math.PI * 2);
                    this.ctx.stroke();
                } else if (p.type === 'speed') {
                    this.ctx.fillStyle = '#ff9800';
                    this.ctx.shadowColor = '#ff9800';
                    this.ctx.shadowBlur = isHovered ? 25 : 15;
                    this.ctx.beginPath();
                    this.ctx.moveTo(-10, -2);
                    this.ctx.lineTo(0, -15);
                    this.ctx.lineTo(0, -6);
                    this.ctx.lineTo(12, -6);
                    this.ctx.lineTo(0, 10);
                    this.ctx.lineTo(0, 0);
                    this.ctx.closePath();
                    this.ctx.fill();
                } else if (p.type === 'magnet') {
                    this.ctx.fillStyle = '#00d9ff';
                    this.ctx.shadowColor = '#00d9ff';
                    this.ctx.shadowBlur = isHovered ? 25 : 15;
                    this.ctx.beginPath();
                    this.ctx.arc(-7, -4, 9, 0, Math.PI, true);
                    this.ctx.arc(7, -4, 9, 0, Math.PI, true);
                    this.ctx.lineTo(7, 10);
                    this.ctx.lineTo(-7, 10);
                    this.ctx.closePath();
                    this.ctx.fill();
                } else if (p.type === 'double') {
                    // Gold gem for double points
                    this.ctx.fillStyle = '#FFD700';
                    this.ctx.shadowColor = '#FFD700';
                    this.ctx.shadowBlur = isHovered ? 30 : 18;
                    this.ctx.beginPath();
                    this.ctx.moveTo(0, -12);
                    this.ctx.lineTo(8, -2);
                    this.ctx.lineTo(4, 12);
                    this.ctx.lineTo(-4, 12);
                    this.ctx.lineTo(-8, -2);
                    this.ctx.closePath();
                    this.ctx.fill();
                    this.ctx.strokeStyle = '#fff3bf';
                    this.ctx.lineWidth = 1;
                    this.ctx.stroke();
                }
                
                // Hover ring
                if (isHovered) {
                    this.ctx.strokeStyle = '#ffffff';
                    this.ctx.lineWidth = 2;
                    this.ctx.globalAlpha = 0.6;
                    this.ctx.shadowBlur = 0;
                    this.ctx.beginPath();
                    this.ctx.arc(0, 0, p.w / 2 + 12, 0, Math.PI * 2);
                    this.ctx.stroke();
                    this.ctx.globalAlpha = 1;
                }
                
                this.ctx.shadowBlur = 0;
                this.ctx.restore();
            }

            drawUI() {
                this.ctx.fillStyle = '#00d9ff';
                this.ctx.shadowColor = '#00d9ff';
                this.ctx.shadowBlur = 10;
                this.ctx.font = 'bold 28px Orbitron, sans-serif';
                this.ctx.fillText(Math.floor(this.manager.score), 25, 45);
                this.ctx.shadowBlur = 0;
                
                this.ctx.font = '18px sans-serif';
                this.ctx.fillStyle = '#ff9800';
                this.ctx.fillText(`💧 ${this.dropsCollected}`, 25, 75);
                
                // Click stats
                if (this.manualCollects > 0) {
                    this.ctx.fillStyle = '#00d9ff';
                    this.ctx.font = '14px sans-serif';
                    this.ctx.fillText(`🖱️ ${this.manualCollects} clicks`, 25, 95);
                }
                
                // Combo
                if (this.combo > 1 && this.comboTimer > 0) {
                    this.ctx.fillStyle = '#ff9800';
                    this.ctx.shadowColor = '#ff9800';
                    this.ctx.shadowBlur = 10;
                    this.ctx.font = 'bold 24px sans-serif';
                    this.ctx.textAlign = 'right';
                    this.ctx.fillText(`x${this.combo} COMBO!`, this.w - 25, 45);
                    this.ctx.shadowBlur = 0;
                    this.ctx.textAlign = 'left';
                }
                
                // Click Power Meter (Top Right)
                const meterX = this.w - 180;
                const meterY = 70;
                this.ctx.font = 'bold 14px sans-serif';
                this.ctx.fillStyle = '#ff9800';
                this.ctx.textAlign = 'right';
                this.ctx.fillText('CLICK POWER', this.w - 25, meterY);
                
                // Draw click power charges
                for (let i = 0; i < this.maxClickPower; i++) {
                    const x = meterX + i * 35;
                    const active = i < this.clickPower;
                    
                    if (active) {
                        this.ctx.fillStyle = '#ff9800';
                        this.ctx.shadowColor = '#ff9800';
                        this.ctx.shadowBlur = 10;
                    } else {
                        this.ctx.fillStyle = 'rgba(255, 152, 0, 0.2)';
                        this.ctx.shadowBlur = 0;
                    }
                    
                    this.ctx.beginPath();
                    this.ctx.arc(x, meterY + 15, 12, 0, Math.PI * 2);
                    this.ctx.fill();
                    
                    if (active) {
                        this.ctx.fillStyle = '#ffffff';
                        this.ctx.font = 'bold 16px sans-serif';
                        this.ctx.textAlign = 'center';
                        this.ctx.fillText('💥', x, meterY + 21);
                    }
                }
                
                // Recharge indicator
                if (this.clickRechargeTimer > 0) {
                    const rechargePercent = 1 - (this.clickRechargeTimer / 300);
                    this.ctx.fillStyle = 'rgba(0, 217, 255, 0.3)';
                    this.ctx.fillRect(meterX - 5, meterY + 35, 110, 6);
                    this.ctx.fillStyle = '#00d9ff';
                    this.ctx.fillRect(meterX - 5, meterY + 35, 110 * rechargePercent, 6);
                    
                    this.ctx.font = '11px sans-serif';
                    this.ctx.fillStyle = '#00d9ff';
                    this.ctx.textAlign = 'right';
                    this.ctx.fillText('Recharging...', this.w - 25, meterY + 52);
                }
                
                this.ctx.shadowBlur = 0;
                this.ctx.textAlign = 'left';
                
                // Power-up timers
                let y = 120;
                const diff = this.getDifficultyMultipliers();
                const baseDurations = { shield: 350, speed: 300, magnet: 350 };
                
                if (this.player.shield) {
                    this.ctx.fillStyle = 'rgba(0, 217, 255, 0.3)';
                    this.ctx.fillRect(25, y, 120, 12);
                    this.ctx.fillStyle = '#00d9ff';
                    this.ctx.fillRect(25, y, (this.powerupTimers.shield / (baseDurations.shield * diff.powerupDuration)) * 120, 12);
                    this.ctx.font = '18px sans-serif';
                    this.ctx.fillText('🛡️', 150, y + 11);
                    y += 22;
                }
                if (this.player.speedBoost) {
                    this.ctx.fillStyle = 'rgba(255, 152, 0, 0.3)';
                    this.ctx.fillRect(25, y, 120, 12);
                    this.ctx.fillStyle = '#ff9800';
                    this.ctx.fillRect(25, y, (this.powerupTimers.speed / (baseDurations.speed * diff.powerupDuration)) * 120, 12);
                    this.ctx.font = '18px sans-serif';
                    this.ctx.fillText('⚡', 150, y + 11);
                    y += 22;
                }
                if (this.player.magnet) {
                    this.ctx.fillStyle = 'rgba(0, 217, 255, 0.3)';
                    this.ctx.fillRect(25, y, 120, 12);
                    this.ctx.fillStyle = '#00d9ff';
                    this.ctx.fillRect(25, y, (this.powerupTimers.magnet / (baseDurations.magnet * diff.powerupDuration)) * 120, 12);
                    this.ctx.font = '18px sans-serif';
                    this.ctx.fillText('🧲', 150, y + 11);
                }
                
                // Help text
                if (this.hoveredDrop || this.hoveredObstacle || this.hoveredPowerup) {
                    this.ctx.fillStyle = 'rgba(0, 0, 0, 0.8)';
                    this.ctx.fillRect(this.w / 2 - 100, this.h - 50, 200, 35);
                    this.ctx.fillStyle = '#00d9ff';
                    this.ctx.font = 'bold 16px sans-serif';
                    this.ctx.textAlign = 'center';
                    
                    if (this.hoveredDrop) {
                        this.ctx.fillText('💧 CLICK TO COLLECT!', this.w / 2, this.h - 28);
                    } else if (this.hoveredObstacle && this.clickPower > 0) {
                        this.ctx.fillText('💥 CLICK TO DESTROY!', this.w / 2, this.h - 28);
                    } else if (this.hoveredPowerup) {
                        this.ctx.fillText('⚡ CLICK TO ACTIVATE!', this.w / 2, this.h - 28);
                    }
                    
                    this.ctx.textAlign = 'left';
                }
            }

            spawnObstacle() {
                // 20% chance to spawn a moving hazard
                if (Math.random() < 0.2) {
                    this.obstacles.push({
                        type: 'moving',
                        x: this.w + 50,
                        y: this.ground - 100 - Math.random() * 60,
                        w: 35,
                        h: 35,
                        vy: (Math.random() < 0.5 ? 1 : -1) * (1 + Math.random()),
                        minY: this.ground - 160,
                        maxY: this.ground - 35
                    });
                } else {
                    this.obstacles.push({
                        type: 'static',
                        x: this.w + 50,
                        y: this.ground - 35,
                        w: 35,
                        h: 35
                    });
                }
            }

            spawnDrop() {
                this.drops.push({
                    x: this.w + 50,
                    y: this.ground - 80 - Math.random() * 140,
                    w: 22,
                    h: 22
                });
            }

            spawnPowerup() {
                const types = ['shield', 'speed', 'magnet', 'double'];
                const type = types[Math.floor(Math.random() * types.length)];
                this.powerups.push({
                    type,
                    x: this.w + 50,
                    y: this.ground - 80 - Math.random() * 100,
                    w: 35,
                    h: 35
                });
            }

            collide(a, b) {
                return a.x < b.x + b.w && a.x + a.w > b.x && a.y < b.y + b.h && a.y + a.h > b.y;
            }

            explode(x, y, count, color) {
                for (let i = 0; i < count; i++) {
                    this.particles.push({
                        x, y,
                        vx: (Math.random() - 0.5) * 10,
                        vy: (Math.random() - 0.5) * 10,
                        life: 45,
                        maxLife: 45,
                        color,
                        size: Math.random() * 5 + 2
                    });
                }
            }
        }

        // ==================== UI Controller ====================
        class UIController {
            constructor(manager) {
                this.manager = manager;
                this.setup();
                this.update();
                this.setupInteractiveStats();
            }

            setup() {
                document.getElementById('soundToggle').onclick = () => this.manager.toggleSound();
                document.getElementById('musicToggle').onclick = () => this.manager.toggleMusic();
                document.getElementById('fullscreenToggle').onclick = () => this.fullscreen();
                const startBtn = document.getElementById('startButton');
                startBtn.onclick = () => {
                    console.log('Begin Mission button clicked');
                    this.start();
                };
                startBtn.disabled = false;
                startBtn.style.display = '';
                document.getElementById('playAgainButton').onclick = () => this.start();
                document.getElementById('backToMenuButton').onclick = () => this.menu();
                document.getElementById('resumeButton').onclick = () => this.resume();
                
                // Initialize music icon state
                document.getElementById('musicIcon').textContent = this.manager.musicEnabled ? '🎵' : '🔇';
            }

            setupInteractiveStats() {
                const stats = [
                    { id: 'statGames', message: '🎮 Keep running!', color: '#00d9ff' },
                    { id: 'statDistance', message: '🏃 Every meter counts!', color: '#ff9800' },
                    { id: 'statDrops', message: '💧 Water is life!', color: '#00d9ff' },
                    { id: 'statRun', message: '🏆 Beat your record!', color: '#ff9800' }
                ];

                stats.forEach(stat => {
                    const el = document.getElementById(stat.id);
                    if (el) {
                        el.addEventListener('click', () => {
                            this.showStatMessage(stat.message, stat.color, el);
                            el.style.transform = 'scale(0.95) rotate(2deg)';
                            setTimeout(() => {
                                el.style.transform = '';
                            }, 200);
                        });
                    }
                });
                // Achievement click animations
                const achievementList = document.getElementById('achievementList');
                if (achievementList) {
                    achievementList.addEventListener('click', (e) => {
                        const achievement = e.target.closest('.achievement');
                        // ...existing code...
                    });
                }
            }

            // ...existing code...
            showGameOver() {
                this.hideAll();
                // Show mission complete overlay
                const missionComplete = document.getElementById('missionCompleteOverlay');
                missionComplete.style.display = 'flex';
                // Play mission complete sound
                const audio = document.getElementById('missionCompleteSound');
                if (audio) { 
                    audio.currentTime = 0; 
                    audio.play().catch(e => console.debug('Mission complete sound delayed'));
                }
                // Confetti animation
                const confetti = missionComplete.querySelector('.mission-complete-confetti');
                confetti.innerHTML = '';
                for (let i = 0; i < 60; i++) {
                    const piece = document.createElement('div');
                    piece.style.position = 'absolute';
                    piece.style.width = '12px';
                    piece.style.height = '18px';
                    piece.style.background = `hsl(${Math.random()*360},90%,60%)`;
                    piece.style.left = Math.random()*100 + '%';
                    piece.style.top = '-30px';
                    piece.style.borderRadius = '3px';
                    piece.style.opacity = 0.85;
                    piece.style.transform = `rotate(${Math.random()*360}deg)`;
                    piece.style.animation = `confettiDrop 1.2s ${Math.random()}s cubic-bezier(.68,-0.55,.27,1.55) forwards`;
                    confetti.appendChild(piece);
                }
                // Sparkle animation - Enhanced
                const sparkles = missionComplete.querySelector('.mission-complete-sparkles');
                sparkles.innerHTML = '';
                for (var i = 0; i < 32; i++) {
                    var sparkle = document.createElement('div');
                    sparkle.className = 'sparkle';
                    var angle = (360 / 32) * i;
                    var radius = 100 + Math.random() * 60;
                    sparkle.style.position = 'absolute';
                    sparkle.style.left = (50 + Math.cos(angle * Math.PI / 180) * radius / 2) + '%';
                    sparkle.style.top = (50 + Math.sin(angle * Math.PI / 180) * radius / 2) + '%';
                    sparkle.style.width = (10 + Math.random() * 8) + 'px';
                    sparkle.style.height = sparkle.style.width;
                    sparkle.style.background = ['#FFD700', '#00d9ff', '#fff'][Math.floor(Math.random() * 3)];
                    sparkle.style.borderRadius = '50%';
                    sparkle.style.boxShadow = '0 0 10px currentColor';
                    sparkle.style.animation = `sparkleFloat 2s ${Math.random() * 2}s infinite ease-in-out`;
                    sparkles.appendChild(sparkle);
                }
                
                // Light rays animation
                const rays = missionComplete.querySelector('.mission-complete-rays');
                rays.innerHTML = '';
                for (var i = 0; i < 12; i++) {
                    var ray = document.createElement('div');
                    ray.style.position = 'absolute';
                    ray.style.width = '2px';
                    ray.style.height = '80%';
                    ray.style.left = '50%';
                    ray.style.top = '50%';
                    ray.style.background = `linear-gradient(to bottom, rgba(255,215,0,0.8), rgba(255,215,0,0))`;
                    ray.style.transform = `translate(-50%, -50%) rotate(${(360/12)*i}deg)`;
                    ray.style.transformOrigin = 'center center';
                    ray.style.animation = `spin 8s linear infinite`;
                    ray.style.opacity = 0.6;
                    rays.appendChild(ray);
                }
                
                // Star burst animation
                const stars = missionComplete.querySelector('.mission-complete-stars');
                stars.innerHTML = '';
                for (var i = 0; i < 20; i++) {
                    var star = document.createElement('div');
                    star.style.position = 'absolute';
                    star.style.left = '50%';
                    star.style.top = '50%';
                    star.style.width = '4px';
                    star.style.height = '4px';
                    star.style.background = '#FFD700';
                    star.style.borderRadius = '50%';
                    star.style.boxShadow = '0 0 6px #FFD700';
                    var angle = (Math.random() * 360);
                    var speed = 3 + Math.random() * 3;
                    star.style.animation = `starBurst ${speed}s ease-out forwards`;
                    star.style.transform = `rotate(${angle}deg) translateX(200px)`;
                    star.style.transformOrigin = '0 0';
                    stars.appendChild(star);
                }
                
                // Add animation keyframes to document
                if (!document.querySelector('style[data-mission-complete]')) {
                    const style = document.createElement('style');
                    style.setAttribute('data-mission-complete', 'true');
                    style.textContent = `
                        @keyframes sparkleFloat {
                            0%, 100% { transform: translateY(0) scale(1); opacity: 1; }
                            50% { transform: translateY(-15px) scale(1.2); opacity: 0.8; }
                        }
                        @keyframes spin {
                            from { transform: translate(-50%, -50%) rotate(0deg); }
                            to { transform: translate(-50%, -50%) rotate(360deg); }
                        }
                        @keyframes starBurst {
                            0% { opacity: 1; transform: rotate(0deg) translateX(0); }
                            100% { opacity: 0; transform: rotate(360deg) translateX(200px); }
                        }
                        @keyframes confettiDrop {
                            0% { transform: translateY(-30px) rotateZ(0deg); opacity: 1; }
                            100% { transform: translateY(100vh) rotateZ(720deg); opacity: 0; }
                        }
                    `;
                    document.head.appendChild(style);
                }
                // Retry and Menu buttons
                const retryBtn = document.getElementById('missionCompleteRetry');
                const menuBtn = document.getElementById('missionCompleteMenu');
                retryBtn.onclick = () => {
                    missionComplete.style.display = 'none';
                    this.manager.startGame();
                    engine.start();
                };
                menuBtn.onclick = () => {
                    missionComplete.style.display = 'none';
                    this.menu();
                };
                this.update();
            }

            showStatMessage(message, color, element) {
                const rect = element.getBoundingClientRect();
                const popup = document.createElement('div');
                popup.className = 'click-hint';
                popup.textContent = message;
                popup.style.left = rect.left + rect.width / 2 + 'px';
                popup.style.top = rect.top + 'px';
                popup.style.background = color;
                popup.style.transform = 'translateX(-50%)';
                document.body.appendChild(popup);
                
                setTimeout(() => {
                    popup.remove();
                }, 1000);
            }

            fullscreen() {
                if (!document.fullscreenElement) {
                    document.documentElement.requestFullscreen();
                } else {
                    document.exitFullscreen();
                }
            }

            start() {
                this.hideAll();
                this.manager.startGame();
                engine.start();
            }

            menu() {
                this.hideAll();
                this.manager.stopBackgroundMusic();
                document.getElementById('menuOverlay').classList.add('active');
                this.update();
            }

            showGameOver() {
                this.hideAll();
                // Show mission complete overlay
                const missionComplete = document.getElementById('missionCompleteOverlay');
                missionComplete.style.display = 'flex';
                // Play mission complete sound
                const audio = document.getElementById('missionCompleteSound');
                if (audio) { 
                    audio.currentTime = 0; 
                    audio.play().catch(e => console.debug('Mission complete sound delayed'));
                }
                // Confetti animation
                const confetti = missionComplete.querySelector('.mission-complete-confetti');
                confetti.innerHTML = '';
                for (let i = 0; i < 60; i++) {
                    const piece = document.createElement('div');
                    piece.style.position = 'absolute';
                    piece.style.width = '12px';
                    piece.style.height = '18px';
                    piece.style.background = `hsl(${Math.random()*360},90%,60%)`;
                    piece.style.left = Math.random()*100 + '%';
                    piece.style.top = '-30px';
                    piece.style.borderRadius = '3px';
                    piece.style.opacity = 0.85;
                    piece.style.transform = `rotate(${Math.random()*360}deg)`;
                    piece.style.animation = `confettiDrop 1.2s ${Math.random()}s cubic-bezier(.68,-0.55,.27,1.55) forwards`;
                    confetti.appendChild(piece);
                }
                // Retry and Menu buttons
                const retryBtn = document.getElementById('missionCompleteRetry');
                const menuBtn = document.getElementById('missionCompleteMenu');
                retryBtn.onclick = () => {
                    missionComplete.style.display = 'none';
                    this.manager.startGame();
                    engine.start();
                };
                menuBtn.onclick = () => {
                    missionComplete.style.display = 'none';
                    this.menu();
                };
                this.update();

            }



            showPause() {
                document.getElementById('pauseOverlay').classList.add('active');
            }

            hidePause() {
                document.getElementById('pauseOverlay').classList.remove('active');
            }

            showHowToPlay() {
                document.getElementById('howToPlayOverlay').classList.add('active');
            }

            hideHowToPlay() {
                document.getElementById('howToPlayOverlay').classList.remove('active');
            }

            hideAll() {
                document.querySelectorAll('.overlay').forEach(el => el.classList.remove('active'));
            }

            update() {
                document.getElementById('menuHighScore').textContent = this.manager.highScore;
                document.getElementById('menuTotalMiles').textContent = Math.floor(this.manager.stats.totalDistance);
                document.getElementById('menuAchievements').textContent = this.manager.achievements.length;

                document.getElementById('currentScore').textContent = Math.floor(this.manager.score);
                const prog = this.manager.highScore > 0 ? (this.manager.score / this.manager.highScore) * 100 : 0;
                document.getElementById('scoreProgress').style.width = Math.min(prog, 100) + '%';

                document.getElementById('gamesPlayed').textContent = this.manager.stats.gamesPlayed;
                document.getElementById('totalDistance').textContent = Math.floor(this.manager.stats.totalDistance) + 'm';
                document.getElementById('totalDrops').textContent = this.manager.stats.totalDrops;
                document.getElementById('longestRun').textContent = Math.floor(this.manager.stats.longestRun) + 'm';
                
                const liters = Math.floor(this.manager.stats.totalDistance);
                document.getElementById('impactCounter').textContent = liters + ' L';

                const list = document.getElementById('achievementList');
                if (this.manager.achievements.length === 0) {
                    list.innerHTML = '<p style="text-align: center; color: var(--cyan-bright); padding: 2rem 0; font-size: 0.875rem;">Complete missions to unlock achievements</p>';
                } else {
                    list.innerHTML = this.manager.achievements.map(a => `
                        <div class="achievement">
                            <div class="achievement-icon">🏆</div>
                            <div class="achievement-details">
                                <h4>${a.title}</h4>
                                <p>${a.desc}</p>
                            </div>
                        </div>
                    `).join('');
                }
            }

            resume() {
                this.hidePause();
                this.manager.resumeGame();
                engine.loop();
            }
// ==================== End UIController class ====================
}

// ==================== Initialize ====================
let manager, engine, ui;
document.addEventListener('DOMContentLoaded', function() {
    manager = new GameManager();
    const canvas = document.getElementById('gameCanvas');
    engine = new GameEngine(canvas, manager);
    ui = new UIController(manager);
    
    // Start menu background music
    manager.startBackgroundMusic();
    // Removed reference to missing tronTheme audio element

    // Auto-play music on first user interaction (browser policy)
    const startMusicOnInteraction = () => {
        const bgMusic = document.getElementById('backgroundMusic');
        if (bgMusic && bgMusic.paused) {
            bgMusic.play().catch(e => console.debug('Music will play when allowed'));
        }
    };
    document.addEventListener('click', startMusicOnInteraction, { once: true });
    document.addEventListener('keydown', startMusicOnInteraction, { once: true });
    document.addEventListener('touchstart', startMusicOnInteraction, { once: true });

    // Update loop
    setInterval(() => {
        if (manager.state === 'playing') {
            ui.update();
        }
    }, 100);

    // Override endGame
    const originalEnd = manager.endGame.bind(manager);
    manager.endGame = function(score, drops, distance, jumps) {
        originalEnd(score, drops, distance, jumps);
        ui.showGameOver();
    };

    // Prevent space scroll
    window.addEventListener('keydown', (e) => {
        if (e.code === 'Space' && e.target === document.body) {
            e.preventDefault();
        }
    });

    // Footer interactions
    document.querySelectorAll('.footer-btn').forEach(btn => {
        btn.addEventListener('click', (e) => {
            // Track clicks (for analytics if needed)
            const action = btn.textContent.includes('Donate') ? 'Donate' : 'Learn More';
            console.log('Charity Water Click:', action);
            // Create ripple effect
            const ripple = document.createElement('div');
            ripple.style.position = 'absolute';
            ripple.style.borderRadius = '50%';
            ripple.style.background = 'rgba(255, 255, 255, 0.5)';
            ripple.style.width = ripple.style.height = '100px';
            ripple.style.left = e.offsetX - 50 + 'px';
            ripple.style.top = e.offsetY - 50 + 'px';
            ripple.style.animation = 'ripple 600ms ease-out';
            ripple.style.pointerEvents = 'none';
            btn.style.position = 'relative';
            btn.appendChild(ripple);
            setTimeout(() => ripple.remove(), 600);
        });
    });

    // Add ripple animation
    const style = document.createElement('style');
    style.textContent = `
        @keyframes ripple {
            0% {
                transform: scale(0);
                opacity: 1;
            }
            100% {
                transform: scale(4);
                opacity: 0;
            }
        }
    `;
    document.head.appendChild(style);

    // How to Play button listeners
    document.getElementById('howToPlayBtn').addEventListener('click', () => {
        ui.showHowToPlay();
    });

    document.getElementById('closeHowToPlay').addEventListener('click', () => {
        ui.hideHowToPlay();
    });

    document.getElementById('closeHowToPlayX').addEventListener('click', () => {
        ui.hideHowToPlay();
    });

    // ESC key support for How to Play overlay
    document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') {
            const howToPlayOverlay = document.getElementById('howToPlayOverlay');
            if (howToPlayOverlay.classList.contains('active')) {
                ui.hideHowToPlay();
            }
        }
    });
});
    </script>
</body>
</html>
